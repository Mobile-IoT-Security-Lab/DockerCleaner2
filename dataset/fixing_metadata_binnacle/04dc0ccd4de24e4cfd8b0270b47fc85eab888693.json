{"seed":4053618503,"processedDockerfileHash":"2b693337a6274776d5da02d6bde9ed91","fixedSmells":["use-no-install-recommends","do-not-use-apt-get-update-alone","pin-package-manager-versions-apt-get","pin-package-manager-versions-pip","pin-package-manager-versions-npm","pin-package-manager-versions-gem","pin-package-manager-versions-apk","use-copy-instead-of-add","use-wget-instead-of-add","do-not-have-secrets","have-a-healthcheck","have-a-user"],"successfullyFixedSmells":["use-no-install-recommends","do-not-use-apt-get-update-alone","pin-package-manager-versions-apt-get","have-a-healthcheck","have-a-user"],"processedDockerfile":"FROM ubuntu:18.04\nCOPY trunk /trunk\n#   Linux: Aliyun Apt Mirrors.\nRUN echo \" deb http://mirrors.aliyun.com/ubuntu/ bionic main restricted \\n deb http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted \\n deb http://mirrors.aliyun.com/ubuntu/ bionic universe \\n deb http://mirrors.aliyun.com/ubuntu/ bionic-updates universe \\n deb http://mirrors.aliyun.com/ubuntu/ bionic multiverse \\n deb http://mirrors.aliyun.com/ubuntu/ bionic-updates multiverse \\n deb http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse \\n deb http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted \\n deb http://mirrors.aliyun.com/ubuntu/ bionic-security universe \\n deb http://mirrors.aliyun.com/ubuntu/ bionic-security multiverse \\n \" > /etc/apt/sources.list \\\n && : \\\n && apt-get -y upgrade\n#   Nginx\nRUN (apt-get update ;apt-get install --no-install-recommends nginx=1.14.0-0ubuntu1.11 -y )\n#   Mysql\nRUN (apt-get update ;apt-get install --no-install-recommends mysql-server=5.7.41-0ubuntu0.18.04.1 libmysqlclient-dev=5.7.41-0ubuntu0.18.04.1 libmysql++-dev=3.2.2+pristine-2ubuntu3 -y ) \\\n && mkdir -p /var/run/mysqld \\\n && chown -R mysql:mysql /var/run/mysqld \\\n && chmod -R 755 /var/run/mysqld \\\n && service mysql start \\\n && mysql < /trunk/install/db.sql \\\n && mysql -e \"insert into jol.privilege values('admin','administrator','N');\"\n#   Php\nRUN DEBIAN_FRONTEND=noninteractive apt-get -y install php-common php-fpm php-mysql php-gd php-zip php-mbstring php-xml\n#   Hustoj basic file system\nRUN useradd -m -u 1536 judge \\\n && mkdir -p /home/judge/etc \\\n && mkdir -p /home/judge/data \\\n && mkdir -p /home/judge/log \\\n && mkdir -p /home/judge/backup \\\n && mv /trunk /home/judge/src \\\n && chmod -R 700 /home/judge/etc \\\n && chmod -R 700 /home/judge/backup \\\n && chmod -R 700 /home/judge/src/web/include/ \\\n && chown -R www-data:www-data /home/judge/data \\\n && chown -R www-data:www-data /home/judge/src/web\n#   Judge daemon and client\nRUN (apt-get update ;apt-get install --no-install-recommends make=4.1-9.1ubuntu1 flex=2.6.4-6 gcc=4:7.4.0-1ubuntu2.3 g++=4:7.4.0-1ubuntu2.3 openjdk-11-jdk=11.0.18+10-0ubuntu1~18.04.1 -y ) \\\n && make -C /home/judge/src/core/judged \\\n && make -C /home/judge/src/core/judge_client \\\n && make exes -C /home/judge/src/core/sim/sim_3_01 \\\n && cp /home/judge/src/core/judged/judged /usr/bin/judged \\\n && cp /home/judge/src/core/judge_client/judge_client /usr/bin/judge_client \\\n && cp /home/judge/src/core/sim/sim_3_01/sim_c.exe /usr/bin/sim_c \\\n && cp /home/judge/src/core/sim/sim_3_01/sim_c++.exe /usr/bin/sim_cc \\\n && cp /home/judge/src/core/sim/sim_3_01/sim_java.exe /usr/bin/sim_java \\\n && cp /home/judge/src/core/sim/sim.sh /usr/bin/sim.sh \\\n && cp /home/judge/src/install/hustoj /etc/init.d/hustoj \\\n && chmod +x /home/judge/src/install/ans2out \\\n && chmod +x /usr/bin/judged \\\n && chmod +X /usr/bin/judge_client \\\n && chmod +x /usr/bin/sim_c \\\n && chmod +X /usr/bin/sim_cc \\\n && chmod +x /usr/bin/sim_java \\\n && chmod +x /usr/bin/sim.sh\n#   Adjust system configuration\nRUN CPU=`grep \"cpu cores\" /proc/cpuinfo | head -1 | awk '{print $4}' ` \\\n && USERNAME=`cat /etc/mysql/debian.cnf | grep user | head -1 | awk '{print $3}' ` \\\n && PASSWORD=`cat /etc/mysql/debian.cnf | grep password | head -1 | awk '{print $3}' ` \\\n && cp /home/judge/src/install/java0.policy /home/judge/etc/ \\\n && cp /home/judge/src/install/judge.conf /home/judge/etc/ \\\n && cp /home/judge/src/install/default.conf /etc/nginx/sites-available/default \\\n && sed -i \"s/OJ_USER_NAME=root/OJ_USER_NAME=$USERNAME/g\" /home/judge/etc/judge.conf \\\n && sed -i \"s/OJ_PASSWORD=root/OJ_PASSWORD=$PASSWORD/g\" /home/judge/etc/judge.conf \\\n && sed -i \"s/OJ_COMPILE_CHROOT=1/OJ_COMPILE_CHROOT=0/g\" /home/judge/etc/judge.conf \\\n && sed -i \"s/OJ_RUNNING=1/OJ_RUNNING=$CPU/g\" /home/judge/etc/judge.conf \\\n && sed -i \"s/OJ_SHM_RUN=1/OJ_SHM_RUN=0/g\" /home/judge/etc/judge.conf \\\n && sed -i \"s/127.0.0.1:9000/unix:\\/var\\/run\\/php\\/php7.2-fpm.sock/g\" /etc/nginx/sites-available/default \\\n && sed -i \"s/DB_USER=\\\"root\\\"/DB_USER=\\\"$USERNAME\\\"/g\" /home/judge/src/web/include/db_info.inc.php \\\n && sed -i \"s/DB_PASS=\\\"root\\\"/DB_PASS=\\\"$PASSWORD\\\"/g\" /home/judge/src/web/include/db_info.inc.php \\\n && for i in $( seq 1 ${CPU} ;); do mkdir -p /home/judge/run`expr ${CPU} - 1 ` ;chown judge /home/judge/run`expr ${CPU} - 1 ` ; done\n#   Install openssh-server\nRUN (apt-get update ;apt-get install --no-install-recommends ssh=1:7.6p1-4ubuntu0.7 -y ) \\\n && echo \"root:root\" | chpasswd \\\n && echo \"PermitRootLogin yes\" >> /etc/ssh/sshd_config\nVOLUME /volume\nENTRYPOINT set -xe \\\n && if [ ! -d /volume/backup ] ; then cp -rp /home/judge/backup /volume/backup ; fi \\\n && if [ ! -d /volume/data ] ; then cp -rp /home/judge/data /volume/data ; fi \\\n && if [ ! -d /volume/etc ] ; then cp -rp /home/judge/etc /volume/etc ; fi \\\n && if [ ! -d /volume/web ] ; then cp -rp /home/judge/src/web /volume/web ; fi \\\n && if [ ! -d /volume/mysql ] ; then cp -rp /var/lib/mysql /volume/mysql ; fi \\\n && chmod -R 700 /volume/etc \\\n && chmod -R 700 /volume/backup \\\n && chmod -R 700 /volume/web/include/ \\\n && chown -R www-data:www-data /volume/data \\\n && chown -R www-data:www-data /volume/web \\\n && chown -R mysql:mysql /var/lib/mysql \\\n && rm -rf /home/judge/backup \\\n && rm -rf /home/judge/data \\\n && rm -rf /home/judge/etc \\\n && rm -rf /home/judge/src/web \\\n && rm -rf /var/lib/mysql \\\n && ln -s /volume/backup /home/judge/backup \\\n && ln -s /volume/data /home/judge/data \\\n && ln -s /volume/etc /home/judge/etc \\\n && ln -s /volume/web /home/judge/src/web \\\n && ln -s /volume/mysql /var/lib/mysql \\\n && service mysql start \\\n && service php7.2-fpm start \\\n && service hustoj start \\\n && service ssh start \\\n && nginx -g \"daemon off;\"\nRUN groupadd --system docker-user ; useradd --system --gid docker-user docker-user\nUSER docker-user\n# Please add your HEALTHCHECK here!!!\n","originalDockerfile":"FROM ubuntu:18.04\nCOPY trunk /trunk\n#  Linux: Aliyun Apt Mirrors.\nRUN echo \" deb http://mirrors.aliyun.com/ubuntu/ bionic main restricted \\n deb http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted \\n deb http://mirrors.aliyun.com/ubuntu/ bionic universe \\n deb http://mirrors.aliyun.com/ubuntu/ bionic-updates universe \\n deb http://mirrors.aliyun.com/ubuntu/ bionic multiverse \\n deb http://mirrors.aliyun.com/ubuntu/ bionic-updates multiverse \\n deb http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse \\n deb http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted \\n deb http://mirrors.aliyun.com/ubuntu/ bionic-security universe \\n deb http://mirrors.aliyun.com/ubuntu/ bionic-security multiverse \\n \" > /etc/apt/sources.list \\\n && apt-get update -y \\\n && apt-get -y upgrade\n#  Nginx\nRUN apt-get install nginx -y\n#  Mysql\nRUN apt-get install mysql-server libmysqlclient-dev libmysql++-dev -y \\\n && mkdir -p /var/run/mysqld \\\n && chown -R mysql:mysql /var/run/mysqld \\\n && chmod -R 755 /var/run/mysqld \\\n && service mysql start \\\n && mysql < /trunk/install/db.sql \\\n && mysql -e \"insert into jol.privilege values('admin','administrator','N');\"\n#  Php\nRUN DEBIAN_FRONTEND=noninteractive apt-get -y install php-common php-fpm php-mysql php-gd php-zip php-mbstring php-xml\n#  Hustoj basic file system\nRUN useradd -m -u 1536 judge \\\n && mkdir -p /home/judge/etc \\\n && mkdir -p /home/judge/data \\\n && mkdir -p /home/judge/log \\\n && mkdir -p /home/judge/backup \\\n && mv /trunk /home/judge/src \\\n && chmod -R 700 /home/judge/etc \\\n && chmod -R 700 /home/judge/backup \\\n && chmod -R 700 /home/judge/src/web/include/ \\\n && chown -R www-data:www-data /home/judge/data \\\n && chown -R www-data:www-data /home/judge/src/web\n#  Judge daemon and client\nRUN apt-get install make flex gcc g++ openjdk-11-jdk -y \\\n && make -C /home/judge/src/core/judged \\\n && make -C /home/judge/src/core/judge_client \\\n && make exes -C /home/judge/src/core/sim/sim_3_01 \\\n && cp /home/judge/src/core/judged/judged /usr/bin/judged \\\n && cp /home/judge/src/core/judge_client/judge_client /usr/bin/judge_client \\\n && cp /home/judge/src/core/sim/sim_3_01/sim_c.exe /usr/bin/sim_c \\\n && cp /home/judge/src/core/sim/sim_3_01/sim_c++.exe /usr/bin/sim_cc \\\n && cp /home/judge/src/core/sim/sim_3_01/sim_java.exe /usr/bin/sim_java \\\n && cp /home/judge/src/core/sim/sim.sh /usr/bin/sim.sh \\\n && cp /home/judge/src/install/hustoj /etc/init.d/hustoj \\\n && chmod +x /home/judge/src/install/ans2out \\\n && chmod +x /usr/bin/judged \\\n && chmod +X /usr/bin/judge_client \\\n && chmod +x /usr/bin/sim_c \\\n && chmod +X /usr/bin/sim_cc \\\n && chmod +x /usr/bin/sim_java \\\n && chmod +x /usr/bin/sim.sh\n#  Adjust system configuration\nRUN CPU=`grep \"cpu cores\" /proc/cpuinfo | head -1 | awk '{print $4}' ` \\\n && USERNAME=`cat /etc/mysql/debian.cnf | grep user | head -1 | awk '{print $3}' ` \\\n && PASSWORD=`cat /etc/mysql/debian.cnf | grep password | head -1 | awk '{print $3}' ` \\\n && cp /home/judge/src/install/java0.policy /home/judge/etc/ \\\n && cp /home/judge/src/install/judge.conf /home/judge/etc/ \\\n && cp /home/judge/src/install/default.conf /etc/nginx/sites-available/default \\\n && sed -i \"s/OJ_USER_NAME=root/OJ_USER_NAME=$USERNAME/g\" /home/judge/etc/judge.conf \\\n && sed -i \"s/OJ_PASSWORD=root/OJ_PASSWORD=$PASSWORD/g\" /home/judge/etc/judge.conf \\\n && sed -i \"s/OJ_COMPILE_CHROOT=1/OJ_COMPILE_CHROOT=0/g\" /home/judge/etc/judge.conf \\\n && sed -i \"s/OJ_RUNNING=1/OJ_RUNNING=$CPU/g\" /home/judge/etc/judge.conf \\\n && sed -i \"s/OJ_SHM_RUN=1/OJ_SHM_RUN=0/g\" /home/judge/etc/judge.conf \\\n && sed -i \"s/127.0.0.1:9000/unix:\\/var\\/run\\/php\\/php7.2-fpm.sock/g\" /etc/nginx/sites-available/default \\\n && sed -i \"s/DB_USER=\\\"root\\\"/DB_USER=\\\"$USERNAME\\\"/g\" /home/judge/src/web/include/db_info.inc.php \\\n && sed -i \"s/DB_PASS=\\\"root\\\"/DB_PASS=\\\"$PASSWORD\\\"/g\" /home/judge/src/web/include/db_info.inc.php \\\n && for i in $( seq 1 ${CPU} ;); do mkdir -p /home/judge/run`expr ${CPU} - 1 ` ;chown judge /home/judge/run`expr ${CPU} - 1 ` ; done\n#  Install openssh-server\nRUN apt-get install ssh -y \\\n && echo \"root:root\" | chpasswd \\\n && echo \"PermitRootLogin yes\" >> /etc/ssh/sshd_config\nVOLUME /volume\nENTRYPOINT set -xe \\\n && if [ ! -d /volume/backup ] ; then cp -rp /home/judge/backup /volume/backup ; fi \\\n && if [ ! -d /volume/data ] ; then cp -rp /home/judge/data /volume/data ; fi \\\n && if [ ! -d /volume/etc ] ; then cp -rp /home/judge/etc /volume/etc ; fi \\\n && if [ ! -d /volume/web ] ; then cp -rp /home/judge/src/web /volume/web ; fi \\\n && if [ ! -d /volume/mysql ] ; then cp -rp /var/lib/mysql /volume/mysql ; fi \\\n && chmod -R 700 /volume/etc \\\n && chmod -R 700 /volume/backup \\\n && chmod -R 700 /volume/web/include/ \\\n && chown -R www-data:www-data /volume/data \\\n && chown -R www-data:www-data /volume/web \\\n && chown -R mysql:mysql /var/lib/mysql \\\n && rm -rf /home/judge/backup \\\n && rm -rf /home/judge/data \\\n && rm -rf /home/judge/etc \\\n && rm -rf /home/judge/src/web \\\n && rm -rf /var/lib/mysql \\\n && ln -s /volume/backup /home/judge/backup \\\n && ln -s /volume/data /home/judge/data \\\n && ln -s /volume/etc /home/judge/etc \\\n && ln -s /volume/web /home/judge/src/web \\\n && ln -s /volume/mysql /var/lib/mysql \\\n && service mysql start \\\n && service php7.2-fpm start \\\n && service hustoj start \\\n && service ssh start \\\n && nginx -g \"daemon off;\"\n","injectedSmells":[],"originalDockerfileHash":"a48057b50b34c374ed414bd7f19d4f47","successfullyInjectedSmells":[],"originalDockerfileUglified":"FROM ubuntu:18.04\nCOPY trunk /trunk\n#   Linux: Aliyun Apt Mirrors.\nRUN echo \" deb http://mirrors.aliyun.com/ubuntu/ bionic main restricted \\n deb http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted \\n deb http://mirrors.aliyun.com/ubuntu/ bionic universe \\n deb http://mirrors.aliyun.com/ubuntu/ bionic-updates universe \\n deb http://mirrors.aliyun.com/ubuntu/ bionic multiverse \\n deb http://mirrors.aliyun.com/ubuntu/ bionic-updates multiverse \\n deb http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse \\n deb http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted \\n deb http://mirrors.aliyun.com/ubuntu/ bionic-security universe \\n deb http://mirrors.aliyun.com/ubuntu/ bionic-security multiverse \\n \" > /etc/apt/sources.list \\\n && apt-get update -y \\\n && apt-get -y upgrade\n#   Nginx\nRUN apt-get install nginx -y\n#   Mysql\nRUN apt-get install mysql-server libmysqlclient-dev libmysql++-dev -y \\\n && mkdir -p /var/run/mysqld \\\n && chown -R mysql:mysql /var/run/mysqld \\\n && chmod -R 755 /var/run/mysqld \\\n && service mysql start \\\n && mysql < /trunk/install/db.sql \\\n && mysql -e \"insert into jol.privilege values('admin','administrator','N');\"\n#   Php\nRUN DEBIAN_FRONTEND=noninteractive apt-get -y install php-common php-fpm php-mysql php-gd php-zip php-mbstring php-xml\n#   Hustoj basic file system\nRUN useradd -m -u 1536 judge \\\n && mkdir -p /home/judge/etc \\\n && mkdir -p /home/judge/data \\\n && mkdir -p /home/judge/log \\\n && mkdir -p /home/judge/backup \\\n && mv /trunk /home/judge/src \\\n && chmod -R 700 /home/judge/etc \\\n && chmod -R 700 /home/judge/backup \\\n && chmod -R 700 /home/judge/src/web/include/ \\\n && chown -R www-data:www-data /home/judge/data \\\n && chown -R www-data:www-data /home/judge/src/web\n#   Judge daemon and client\nRUN apt-get install make flex gcc g++ openjdk-11-jdk -y \\\n && make -C /home/judge/src/core/judged \\\n && make -C /home/judge/src/core/judge_client \\\n && make exes -C /home/judge/src/core/sim/sim_3_01 \\\n && cp /home/judge/src/core/judged/judged /usr/bin/judged \\\n && cp /home/judge/src/core/judge_client/judge_client /usr/bin/judge_client \\\n && cp /home/judge/src/core/sim/sim_3_01/sim_c.exe /usr/bin/sim_c \\\n && cp /home/judge/src/core/sim/sim_3_01/sim_c++.exe /usr/bin/sim_cc \\\n && cp /home/judge/src/core/sim/sim_3_01/sim_java.exe /usr/bin/sim_java \\\n && cp /home/judge/src/core/sim/sim.sh /usr/bin/sim.sh \\\n && cp /home/judge/src/install/hustoj /etc/init.d/hustoj \\\n && chmod +x /home/judge/src/install/ans2out \\\n && chmod +x /usr/bin/judged \\\n && chmod +X /usr/bin/judge_client \\\n && chmod +x /usr/bin/sim_c \\\n && chmod +X /usr/bin/sim_cc \\\n && chmod +x /usr/bin/sim_java \\\n && chmod +x /usr/bin/sim.sh\n#   Adjust system configuration\nRUN CPU=`grep \"cpu cores\" /proc/cpuinfo | head -1 | awk '{print $4}' ` \\\n && USERNAME=`cat /etc/mysql/debian.cnf | grep user | head -1 | awk '{print $3}' ` \\\n && PASSWORD=`cat /etc/mysql/debian.cnf | grep password | head -1 | awk '{print $3}' ` \\\n && cp /home/judge/src/install/java0.policy /home/judge/etc/ \\\n && cp /home/judge/src/install/judge.conf /home/judge/etc/ \\\n && cp /home/judge/src/install/default.conf /etc/nginx/sites-available/default \\\n && sed -i \"s/OJ_USER_NAME=root/OJ_USER_NAME=$USERNAME/g\" /home/judge/etc/judge.conf \\\n && sed -i \"s/OJ_PASSWORD=root/OJ_PASSWORD=$PASSWORD/g\" /home/judge/etc/judge.conf \\\n && sed -i \"s/OJ_COMPILE_CHROOT=1/OJ_COMPILE_CHROOT=0/g\" /home/judge/etc/judge.conf \\\n && sed -i \"s/OJ_RUNNING=1/OJ_RUNNING=$CPU/g\" /home/judge/etc/judge.conf \\\n && sed -i \"s/OJ_SHM_RUN=1/OJ_SHM_RUN=0/g\" /home/judge/etc/judge.conf \\\n && sed -i \"s/127.0.0.1:9000/unix:\\/var\\/run\\/php\\/php7.2-fpm.sock/g\" /etc/nginx/sites-available/default \\\n && sed -i \"s/DB_USER=\\\"root\\\"/DB_USER=\\\"$USERNAME\\\"/g\" /home/judge/src/web/include/db_info.inc.php \\\n && sed -i \"s/DB_PASS=\\\"root\\\"/DB_PASS=\\\"$PASSWORD\\\"/g\" /home/judge/src/web/include/db_info.inc.php \\\n && for i in $( seq 1 ${CPU} ;); do mkdir -p /home/judge/run`expr ${CPU} - 1 ` ;chown judge /home/judge/run`expr ${CPU} - 1 ` ; done\n#   Install openssh-server\nRUN apt-get install ssh -y \\\n && echo \"root:root\" | chpasswd \\\n && echo \"PermitRootLogin yes\" >> /etc/ssh/sshd_config\nVOLUME /volume\nENTRYPOINT set -xe \\\n && if [ ! -d /volume/backup ] ; then cp -rp /home/judge/backup /volume/backup ; fi \\\n && if [ ! -d /volume/data ] ; then cp -rp /home/judge/data /volume/data ; fi \\\n && if [ ! -d /volume/etc ] ; then cp -rp /home/judge/etc /volume/etc ; fi \\\n && if [ ! -d /volume/web ] ; then cp -rp /home/judge/src/web /volume/web ; fi \\\n && if [ ! -d /volume/mysql ] ; then cp -rp /var/lib/mysql /volume/mysql ; fi \\\n && chmod -R 700 /volume/etc \\\n && chmod -R 700 /volume/backup \\\n && chmod -R 700 /volume/web/include/ \\\n && chown -R www-data:www-data /volume/data \\\n && chown -R www-data:www-data /volume/web \\\n && chown -R mysql:mysql /var/lib/mysql \\\n && rm -rf /home/judge/backup \\\n && rm -rf /home/judge/data \\\n && rm -rf /home/judge/etc \\\n && rm -rf /home/judge/src/web \\\n && rm -rf /var/lib/mysql \\\n && ln -s /volume/backup /home/judge/backup \\\n && ln -s /volume/data /home/judge/data \\\n && ln -s /volume/etc /home/judge/etc \\\n && ln -s /volume/web /home/judge/src/web \\\n && ln -s /volume/mysql /var/lib/mysql \\\n && service mysql start \\\n && service php7.2-fpm start \\\n && service hustoj start \\\n && service ssh start \\\n && nginx -g \"daemon off;\"\n","originalDockerfileUglifiedHash":"63848f5658722fa441999d150a649c5c","fileName":"/ICSME-replicationpackage/dataset/smelly_dockerfiles_bianncle/04dc0ccd4de24e4cfd8b0270b47fc85eab888693.dockerfile"}