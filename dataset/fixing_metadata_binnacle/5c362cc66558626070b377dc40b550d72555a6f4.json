{"seed":2323950980,"processedDockerfileHash":"5b08966cc0ac170b066a6d0a8386e982","fixedSmells":["use-no-install-recommends","do-not-use-apt-get-update-alone","pin-package-manager-versions-apt-get","pin-package-manager-versions-pip","pin-package-manager-versions-npm","pin-package-manager-versions-gem","pin-package-manager-versions-apk","use-copy-instead-of-add","use-wget-instead-of-add","do-not-have-secrets","have-a-healthcheck","have-a-user"],"successfullyFixedSmells":["pin-package-manager-versions-apt-get","use-copy-instead-of-add","have-a-healthcheck","have-a-user"],"processedDockerfile":"#   Dockerfile for CNTK-CPU-Infiniband-IntelMPI for use with Batch Shipyard on Azure Batch\nFROM ubuntu:16.04\nMAINTAINER Fred Park <https://github.com/Azure/batch-shipyard>\n#   install base system\nCOPY ssh_config /root/.ssh/config\nRUN apt-get update \\\n && apt-get install --no-install-recommends autotools-dev=20150820.1 build-essential=12.1ubuntu2 cmake=3.5.1-1ubuntu3 git=1:2.7.4-0ubuntu1.10 gfortran-multilib=4:5.3.1-1ubuntu1 libavcodec-dev=7:2.8.17-0ubuntu0.1 libavformat-dev=7:2.8.17-0ubuntu0.1 libjasper-dev=1.900.1-debian1-2.4ubuntu1.3 libjpeg-dev=8c-2ubuntu8 libpng-dev liblapacke-dev=3.6.0-2ubuntu2 libswscale-dev=7:2.8.17-0ubuntu0.1 libtiff-dev pkg-config=0.29.1-0ubuntu1 wget=1.17.1-1ubuntu1.5 zlib1g-dev=1:1.2.8.dfsg-2ubuntu4.3 ca-certificates=20210119~16.04.1 curl=7.47.0-1ubuntu2.19 unzip=6.0-20ubuntu1.1 python-dev=2.7.12-1~16.04 automake=1:1.15-4ubuntu1 libtool=2.4.6-0.1 autoconf=2.69-9 subversion=1.9.3-2ubuntu1.3 libapr1=1.5.2-3 libaprutil1=1.5.4-1build1 libltdl-dev=2.4.6-0.1 libltdl7=2.4.6-0.1 libserf-1-1=1.3.8-1 libsigsegv2=2.10-4 libsvn1=1.9.3-2ubuntu1.3 m4=1.4.17-5 openjdk-9-jdk-headless=9~b114-0ubuntu1 libpcre3-dev=2:8.38-3.1 libpcre++-dev=0.9.5-6.1 -y \\\n && apt-get install --no-install-recommends cpio=2.11+dfsg-5ubuntu1.1 libmlx4-1=1.0.6-1ubuntu3 libmlx5-1=1.0.2-1ubuntu2 librdmacm1=1.0.21-1 libibverbs1=1.1.8-1.1ubuntu2 libmthca1=1.0.6-1ubuntu1 libdapl2=2.1.5-1 dapl2-utils=2.1.5-1 openssh-server=1:7.2p2-4ubuntu2.10 openssh-client=1:7.2p2-4ubuntu2.10 -y \\\n && rm -rf /var/lib/apt/lists/* \\\n && mkdir /var/run/sshd \\\n && ssh-keygen -A \\\n && sed -i 's/PermitRootLogin without-password/PermitRootLogin yes/' /etc/ssh/sshd_config \\\n && sed 's@session\\s*required\\s*pam_loginuid.so@session optional pam_loginuid.so@g' -i /etc/pam.d/sshd \\\n && ssh-keygen -f /root/.ssh/id_rsa -t rsa -N '' \\\n && chmod 600 /root/.ssh/config \\\n && chmod 700 /root/.ssh \\\n && cp /root/.ssh/id_rsa.pub /root/.ssh/authorized_keys\n#   build and install libzip, boost, openblas, opencv, protobuf\nRUN LIBZIP_VERSION=1.1.3 \\\n && wget -q -O - http://nih.at/libzip/libzip-${LIBZIP_VERSION}.tar.gz | tar -xzf - \\\n && cd libzip-${LIBZIP_VERSION} \\\n && ./configure --prefix=/usr/local \\\n && make -j\"$( nproc ;)\" install \\\n && ldconfig /usr/local/lib \\\n && cd .. \\\n && rm -rf /libzip-${LIBZIP_VERSION} \\\n && BOOST_VERSION=1_60_0 \\\n && BOOST_DOTTED_VERSION=$( echo $BOOST_VERSION | tr _ . ;) \\\n && wget -q -O - https://sourceforge.net/projects/boost/files/boost/${BOOST_DOTTED_VERSION}/boost_${BOOST_VERSION}.tar.gz/download | tar -xzf - \\\n && cd boost_${BOOST_VERSION} \\\n && ./bootstrap.sh --prefix=/usr/local --with-libraries=filesystem,system,test \\\n && ./b2 -d0 -j\"$( nproc ;)\" install \\\n && ldconfig /usr/local/lib \\\n && cd .. \\\n && rm -rf /boost_${BOOST_VERSION} \\\n && OPENBLAS_VERSION=0.2.19 \\\n && wget -q -O - https://github.com/xianyi/OpenBLAS/archive/v${OPENBLAS_VERSION}.tar.gz | tar -xzf - \\\n && cd OpenBLAS-${OPENBLAS_VERSION} \\\n && make -j\"$( nproc ;)\" USE_OPENMP=1 | tee make.log \\\n && grep -qF 'OpenBLAS build complete. (BLAS CBLAS LAPACK LAPACKE)' make.log \\\n && grep -qF 'Use OpenMP in the multithreading.' make.log \\\n && make PREFIX=/usr/local/openblas install \\\n && ldconfig /usr/local/openblas \\\n && cd .. \\\n && rm -rf /OpenBLAS-${OPENBLAS_VERSION} \\\n && OPENCV_VERSION=3.1.0 \\\n && wget -q -O - https://github.com/opencv/opencv/archive/${OPENCV_VERSION}.tar.gz | tar -xzf - \\\n && cd opencv-${OPENCV_VERSION} \\\n && cmake -DWITH_CUDA=OFF -DCMAKE_BUILD_TYPE=RELEASE -DCMAKE_INSTALL_PREFIX=/usr/local/opencv-${OPENCV_VERSION} . \\\n && make -j\"$( nproc ;)\" install \\\n && ldconfig /usr/local/lib \\\n && cd .. \\\n && rm -rf /opencv-${OPENCV_VERSION} \\\n && PROTOBUF_VERSION=3.1.0 PROTOBUF_STRING=protobuf-$PROTOBUF_VERSION \\\n && wget -O - --no-verbose https://github.com/google/protobuf/archive/v${PROTOBUF_VERSION}.tar.gz | tar -xzf - \\\n && cd $PROTOBUF_STRING \\\n && ./autogen.sh \\\n && ./configure CFLAGS=-fPIC CXXFLAGS=-fPIC --disable-shared --prefix=/usr/local/$PROTOBUF_STRING \\\n && make -j $( nproc ;) install \\\n && cd .. \\\n && rm -rf $PROTOBUF_STRING\n#   set env vars\nENV KALDI_VERSION=\"c024e8aa\"\nENV PATH=\"/root/anaconda3/envs/cntk-py36/bin:/usr/local/bin:/cntk/build-mkl/cpu/release/bin:${PATH}\" \\\n    KALDI_PATH=\"/usr/local/kaldi-$KALDI_VERSION\" \\\n    BLAS=\"/usr/local/openblas/lib/libopenblas.so\" \\\n    LAPACK=\"/usr/local/openblas/lib/libopenblas.so\" \\\n    MKL_PATH=\"/usr/local/CNTKCustomMKL\" \\\n    PYTHONPATH=\"/cntk/bindings/python:$PYTHONPATH\" \\\n    LD_LIBRARY_PATH=\"/usr/local/openblas/lib:/cntk/bindings/python/cntk/libs:$LD_LIBRARY_PATH\"\n#   install cntk custom mkl, kaldi, swig and anaconda\nRUN CNTK_CUSTOM_MKL_VERSION=3 \\\n && mkdir ${MKL_PATH} \\\n && wget --no-verbose -O - https://www.cntk.ai/mkl/CNTKCustomMKL-Linux-$CNTK_CUSTOM_MKL_VERSION.tgz | tar -xzf - -C ${MKL_PATH} \\\n && mkdir $KALDI_PATH \\\n && wget --no-verbose -O - https://github.com/kaldi-asr/kaldi/archive/$KALDI_VERSION.tar.gz | tar -xzf - --strip-components=1 -C $KALDI_PATH \\\n && cd $KALDI_PATH/tools \\\n && perl -pi -e 's/^# (OPENFST_VERSION = 1.4.1)$/\\1/' Makefile \\\n && make -j $( nproc ;) sph2pipe atlas sclite openfst \\\n && cd ../src \\\n && ./configure --openblas-root=/usr/local/openblas --shared \\\n && make -j $( nproc ;) depend \\\n && make -j $( nproc ;) all \\\n && find $KALDI_PATH -name '*.o' -print0 | xargs -0 rm \\\n && for dir in $KALDI_PATH/src/*bin; do make -C $dir clean ; done \\\n && SWIG_VERSION=3.0.10 \\\n && cd /root \\\n && wget -q http://prdownloads.sourceforge.net/swig/swig-${SWIG_VERSION}.tar.gz -O - | tar xvfz - \\\n && cd swig-${SWIG_VERSION} \\\n && ./configure --without-alllang \\\n && make -j$( nproc ;) \\\n && make install \\\n && cd .. \\\n && rm -rf swig-${SWIG_VERSION} \\\n && wget -q https://repo.continuum.io/archive/Anaconda3-4.4.0-Linux-x86_64.sh \\\n && bash Anaconda3-4.4.0-Linux-x86_64.sh -b \\\n && rm -f Anaconda3-4.4.0-Linux-x86_64.sh \\\n && ldconfig /usr/local/lib\n#   set cntk dir\nWORKDIR /cntk\n#   add intel mpi library and build cntk\nENV MANPATH=\"/usr/share/man:/usr/local/man\" \\\n    COMPILERVARS_ARCHITECTURE=\"intel64\" \\\n    COMPILERVARS_PLATFORM=\"linux\" \\\n    INTEL_MPI_PATH=\"/opt/intel/compilers_and_libraries/linux/mpi\"\nCOPY l_mpi_2017.2.174.tgz /tmp\nCOPY USE_SERVER.lic /tmp/l_mpi_2017.2.174/\nRUN sed -i -e 's/^ACCEPT_EULA=decline/ACCEPT_EULA=accept/g' /tmp/l_mpi_2017.2.174/silent.cfg \\\n && sed -i -e 's|^#ACTIVATION_LICENSE_FILE=|ACTIVATION_LICENSE_FILE=/tmp/l_mpi_2017.2.174/USE_SERVER.lic|g' /tmp/l_mpi_2017.2.174/silent.cfg \\\n && sed -i -e 's/^ACTIVATION_TYPE=exist_lic/ACTIVATION_TYPE=license_server/g' /tmp/l_mpi_2017.2.174/silent.cfg \\\n && cd /tmp/l_mpi_2017.2.174 \\\n && ./install.sh -s silent.cfg \\\n && cd .. \\\n && rm -rf l_mpi_2017.2.174 \\\n && ln -s ${INTEL_MPI_PATH}/${COMPILERVARS_ARCHITECTURE}/bin/mpicxx ${INTEL_MPI_PATH}/${COMPILERVARS_ARCHITECTURE}/bin/mpic++ \\\n && CNTK_VERSION=v2.1 \\\n && cd /cntk \\\n && git clone --depth=1 --recursive -b ${CNTK_VERSION} --single-branch https://github.com/Microsoft/CNTK.git . \\\n && /root/anaconda3/bin/conda env create -p /root/anaconda3/envs/cntk-py36/ --file /cntk/Scripts/install/linux/conda-linux-cntk-py36-environment.yml \\\n && . /opt/intel/bin/compilervars.sh \\\n && . /opt/intel/compilers_and_libraries/linux/mpi/bin64/mpivars.sh \\\n && CONFIGURE_OPTS=\" --1bitsgd=yes --with-mpi=${INTEL_MPI_PATH}/${COMPILERVARS_ARCHITECTURE} --with-kaldi=${KALDI_PATH} --with-py36-path=/root/anaconda3/envs/cntk-py36\" \\\n && mkdir -p build-mkl/cpu/release \\\n && cd build-mkl/cpu/release \\\n && ../../../configure $CONFIGURE_OPTS --with-mkl=${MKL_PATH} \\\n && make -j\"$( nproc ;)\" all \\\n && rm -rf /cntk/build-mkl/cpu/release/.build \\\n && rm -rf /cntk/.git \\\n && /root/anaconda3/bin/conda clean --all --yes \\\n && echo \"source /root/anaconda3/bin/activate /root/anaconda3/envs/cntk-py36\" > /cntk/activate-cntk \\\n && echo \"source /cntk/activate-cntk\" >> /root/.bashrc \\\n && echo LD_LIBRARY_PATH=${LD_LIBRARY_PATH}:'$LD_LIBRARY_PATH' >> /root/.bashrc \\\n && rm -rf /opt/intel\n#   set sshd command\nEXPOSE 23/tcp\nCMD [\"/usr/sbin/sshd\", \"-D\", \"-p\", \"23\"]\n#   copy in intel mpirun helper script on Batch\nCOPY run_cntk.sh /cntk/\nRUN groupadd --system docker-user ; useradd --system --gid docker-user docker-user\nUSER docker-user\n# Please add your HEALTHCHECK here!!!\n","originalDockerfile":"#  Dockerfile for CNTK-CPU-Infiniband-IntelMPI for use with Batch Shipyard on Azure Batch\nFROM ubuntu:16.04\nMAINTAINER Fred Park <https://github.com/Azure/batch-shipyard>\n#  install base system\nCOPY ssh_config /root/.ssh/config\nRUN apt-get update \\\n && apt-get install --no-install-recommends autotools-dev build-essential cmake git gfortran-multilib libavcodec-dev libavformat-dev libjasper-dev libjpeg-dev libpng-dev liblapacke-dev libswscale-dev libtiff-dev pkg-config wget zlib1g-dev ca-certificates curl unzip python-dev automake libtool autoconf subversion libapr1 libaprutil1 libltdl-dev libltdl7 libserf-1-1 libsigsegv2 libsvn1 m4 openjdk-9-jdk-headless libpcre3-dev libpcre++-dev -y \\\n && apt-get install --no-install-recommends cpio libmlx4-1 libmlx5-1 librdmacm1 libibverbs1 libmthca1 libdapl2 dapl2-utils openssh-server openssh-client -y \\\n && rm -rf /var/lib/apt/lists/* \\\n && mkdir /var/run/sshd \\\n && ssh-keygen -A \\\n && sed -i 's/PermitRootLogin without-password/PermitRootLogin yes/' /etc/ssh/sshd_config \\\n && sed 's@session\\s*required\\s*pam_loginuid.so@session optional pam_loginuid.so@g' -i /etc/pam.d/sshd \\\n && ssh-keygen -f /root/.ssh/id_rsa -t rsa -N '' \\\n && chmod 600 /root/.ssh/config \\\n && chmod 700 /root/.ssh \\\n && cp /root/.ssh/id_rsa.pub /root/.ssh/authorized_keys\n#  build and install libzip, boost, openblas, opencv, protobuf\nRUN LIBZIP_VERSION=1.1.3 \\\n && wget -q -O - http://nih.at/libzip/libzip-${LIBZIP_VERSION}.tar.gz | tar -xzf - \\\n && cd libzip-${LIBZIP_VERSION} \\\n && ./configure --prefix=/usr/local \\\n && make -j\"$( nproc ;)\" install \\\n && ldconfig /usr/local/lib \\\n && cd .. \\\n && rm -rf /libzip-${LIBZIP_VERSION} \\\n && BOOST_VERSION=1_60_0 \\\n && BOOST_DOTTED_VERSION=$( echo $BOOST_VERSION | tr _ . ;) \\\n && wget -q -O - https://sourceforge.net/projects/boost/files/boost/${BOOST_DOTTED_VERSION}/boost_${BOOST_VERSION}.tar.gz/download | tar -xzf - \\\n && cd boost_${BOOST_VERSION} \\\n && ./bootstrap.sh --prefix=/usr/local --with-libraries=filesystem,system,test \\\n && ./b2 -d0 -j\"$( nproc ;)\" install \\\n && ldconfig /usr/local/lib \\\n && cd .. \\\n && rm -rf /boost_${BOOST_VERSION} \\\n && OPENBLAS_VERSION=0.2.19 \\\n && wget -q -O - https://github.com/xianyi/OpenBLAS/archive/v${OPENBLAS_VERSION}.tar.gz | tar -xzf - \\\n && cd OpenBLAS-${OPENBLAS_VERSION} \\\n && make -j\"$( nproc ;)\" USE_OPENMP=1 | tee make.log \\\n && grep -qF 'OpenBLAS build complete. (BLAS CBLAS LAPACK LAPACKE)' make.log \\\n && grep -qF 'Use OpenMP in the multithreading.' make.log \\\n && make PREFIX=/usr/local/openblas install \\\n && ldconfig /usr/local/openblas \\\n && cd .. \\\n && rm -rf /OpenBLAS-${OPENBLAS_VERSION} \\\n && OPENCV_VERSION=3.1.0 \\\n && wget -q -O - https://github.com/opencv/opencv/archive/${OPENCV_VERSION}.tar.gz | tar -xzf - \\\n && cd opencv-${OPENCV_VERSION} \\\n && cmake -DWITH_CUDA=OFF -DCMAKE_BUILD_TYPE=RELEASE -DCMAKE_INSTALL_PREFIX=/usr/local/opencv-${OPENCV_VERSION} . \\\n && make -j\"$( nproc ;)\" install \\\n && ldconfig /usr/local/lib \\\n && cd .. \\\n && rm -rf /opencv-${OPENCV_VERSION} \\\n && PROTOBUF_VERSION=3.1.0 PROTOBUF_STRING=protobuf-$PROTOBUF_VERSION \\\n && wget -O - --no-verbose https://github.com/google/protobuf/archive/v${PROTOBUF_VERSION}.tar.gz | tar -xzf - \\\n && cd $PROTOBUF_STRING \\\n && ./autogen.sh \\\n && ./configure CFLAGS=-fPIC CXXFLAGS=-fPIC --disable-shared --prefix=/usr/local/$PROTOBUF_STRING \\\n && make -j $( nproc ;) install \\\n && cd .. \\\n && rm -rf $PROTOBUF_STRING\n#  set env vars\nENV KALDI_VERSION=\"c024e8aa\"\nENV PATH=\"/root/anaconda3/envs/cntk-py36/bin:/usr/local/bin:/cntk/build-mkl/cpu/release/bin:${PATH}\" \\\n    KALDI_PATH=\"/usr/local/kaldi-$KALDI_VERSION\" \\\n    BLAS=\"/usr/local/openblas/lib/libopenblas.so\" \\\n    LAPACK=\"/usr/local/openblas/lib/libopenblas.so\" \\\n    MKL_PATH=\"/usr/local/CNTKCustomMKL\" \\\n    PYTHONPATH=\"/cntk/bindings/python:$PYTHONPATH\" \\\n    LD_LIBRARY_PATH=\"/usr/local/openblas/lib:/cntk/bindings/python/cntk/libs:$LD_LIBRARY_PATH\"\n#  install cntk custom mkl, kaldi, swig and anaconda\nRUN CNTK_CUSTOM_MKL_VERSION=3 \\\n && mkdir ${MKL_PATH} \\\n && wget --no-verbose -O - https://www.cntk.ai/mkl/CNTKCustomMKL-Linux-$CNTK_CUSTOM_MKL_VERSION.tgz | tar -xzf - -C ${MKL_PATH} \\\n && mkdir $KALDI_PATH \\\n && wget --no-verbose -O - https://github.com/kaldi-asr/kaldi/archive/$KALDI_VERSION.tar.gz | tar -xzf - --strip-components=1 -C $KALDI_PATH \\\n && cd $KALDI_PATH/tools \\\n && perl -pi -e 's/^# (OPENFST_VERSION = 1.4.1)$/\\1/' Makefile \\\n && make -j $( nproc ;) sph2pipe atlas sclite openfst \\\n && cd ../src \\\n && ./configure --openblas-root=/usr/local/openblas --shared \\\n && make -j $( nproc ;) depend \\\n && make -j $( nproc ;) all \\\n && find $KALDI_PATH -name '*.o' -print0 | xargs -0 rm \\\n && for dir in $KALDI_PATH/src/*bin; do make -C $dir clean ; done \\\n && SWIG_VERSION=3.0.10 \\\n && cd /root \\\n && wget -q http://prdownloads.sourceforge.net/swig/swig-${SWIG_VERSION}.tar.gz -O - | tar xvfz - \\\n && cd swig-${SWIG_VERSION} \\\n && ./configure --without-alllang \\\n && make -j$( nproc ;) \\\n && make install \\\n && cd .. \\\n && rm -rf swig-${SWIG_VERSION} \\\n && wget -q https://repo.continuum.io/archive/Anaconda3-4.4.0-Linux-x86_64.sh \\\n && bash Anaconda3-4.4.0-Linux-x86_64.sh -b \\\n && rm -f Anaconda3-4.4.0-Linux-x86_64.sh \\\n && ldconfig /usr/local/lib\n#  set cntk dir\nWORKDIR /cntk\n#  add intel mpi library and build cntk\nENV MANPATH=\"/usr/share/man:/usr/local/man\" \\\n    COMPILERVARS_ARCHITECTURE=\"intel64\" \\\n    COMPILERVARS_PLATFORM=\"linux\" \\\n    INTEL_MPI_PATH=\"/opt/intel/compilers_and_libraries/linux/mpi\"\nADD l_mpi_2017.2.174.tgz /tmp\nCOPY USE_SERVER.lic /tmp/l_mpi_2017.2.174/\nRUN sed -i -e 's/^ACCEPT_EULA=decline/ACCEPT_EULA=accept/g' /tmp/l_mpi_2017.2.174/silent.cfg \\\n && sed -i -e 's|^#ACTIVATION_LICENSE_FILE=|ACTIVATION_LICENSE_FILE=/tmp/l_mpi_2017.2.174/USE_SERVER.lic|g' /tmp/l_mpi_2017.2.174/silent.cfg \\\n && sed -i -e 's/^ACTIVATION_TYPE=exist_lic/ACTIVATION_TYPE=license_server/g' /tmp/l_mpi_2017.2.174/silent.cfg \\\n && cd /tmp/l_mpi_2017.2.174 \\\n && ./install.sh -s silent.cfg \\\n && cd .. \\\n && rm -rf l_mpi_2017.2.174 \\\n && ln -s ${INTEL_MPI_PATH}/${COMPILERVARS_ARCHITECTURE}/bin/mpicxx ${INTEL_MPI_PATH}/${COMPILERVARS_ARCHITECTURE}/bin/mpic++ \\\n && CNTK_VERSION=v2.1 \\\n && cd /cntk \\\n && git clone --depth=1 --recursive -b ${CNTK_VERSION} --single-branch https://github.com/Microsoft/CNTK.git . \\\n && /root/anaconda3/bin/conda env create -p /root/anaconda3/envs/cntk-py36/ --file /cntk/Scripts/install/linux/conda-linux-cntk-py36-environment.yml \\\n && . /opt/intel/bin/compilervars.sh \\\n && . /opt/intel/compilers_and_libraries/linux/mpi/bin64/mpivars.sh \\\n && CONFIGURE_OPTS=\" --1bitsgd=yes --with-mpi=${INTEL_MPI_PATH}/${COMPILERVARS_ARCHITECTURE} --with-kaldi=${KALDI_PATH} --with-py36-path=/root/anaconda3/envs/cntk-py36\" \\\n && mkdir -p build-mkl/cpu/release \\\n && cd build-mkl/cpu/release \\\n && ../../../configure $CONFIGURE_OPTS --with-mkl=${MKL_PATH} \\\n && make -j\"$( nproc ;)\" all \\\n && rm -rf /cntk/build-mkl/cpu/release/.build \\\n && rm -rf /cntk/.git \\\n && /root/anaconda3/bin/conda clean --all --yes \\\n && echo \"source /root/anaconda3/bin/activate /root/anaconda3/envs/cntk-py36\" > /cntk/activate-cntk \\\n && echo \"source /cntk/activate-cntk\" >> /root/.bashrc \\\n && echo LD_LIBRARY_PATH=${LD_LIBRARY_PATH}:'$LD_LIBRARY_PATH' >> /root/.bashrc \\\n && rm -rf /opt/intel\n#  set sshd command\nEXPOSE 23/tcp\nCMD [\"/usr/sbin/sshd\", \"-D\", \"-p\", \"23\"]\n#  copy in intel mpirun helper script on Batch\nCOPY run_cntk.sh /cntk/\n","injectedSmells":[],"originalDockerfileHash":"cbce4501d800164a8cf3b6d28a84ad84","successfullyInjectedSmells":[],"originalDockerfileUglified":"#   Dockerfile for CNTK-CPU-Infiniband-IntelMPI for use with Batch Shipyard on Azure Batch\nFROM ubuntu:16.04\nMAINTAINER Fred Park <https://github.com/Azure/batch-shipyard>\n#   install base system\nCOPY ssh_config /root/.ssh/config\nRUN apt-get update \\\n && apt-get install --no-install-recommends autotools-dev build-essential cmake git gfortran-multilib libavcodec-dev libavformat-dev libjasper-dev libjpeg-dev libpng-dev liblapacke-dev libswscale-dev libtiff-dev pkg-config wget zlib1g-dev ca-certificates curl unzip python-dev automake libtool autoconf subversion libapr1 libaprutil1 libltdl-dev libltdl7 libserf-1-1 libsigsegv2 libsvn1 m4 openjdk-9-jdk-headless libpcre3-dev libpcre++-dev -y \\\n && apt-get install --no-install-recommends cpio libmlx4-1 libmlx5-1 librdmacm1 libibverbs1 libmthca1 libdapl2 dapl2-utils openssh-server openssh-client -y \\\n && rm -rf /var/lib/apt/lists/* \\\n && mkdir /var/run/sshd \\\n && ssh-keygen -A \\\n && sed -i 's/PermitRootLogin without-password/PermitRootLogin yes/' /etc/ssh/sshd_config \\\n && sed 's@session\\s*required\\s*pam_loginuid.so@session optional pam_loginuid.so@g' -i /etc/pam.d/sshd \\\n && ssh-keygen -f /root/.ssh/id_rsa -t rsa -N '' \\\n && chmod 600 /root/.ssh/config \\\n && chmod 700 /root/.ssh \\\n && cp /root/.ssh/id_rsa.pub /root/.ssh/authorized_keys\n#   build and install libzip, boost, openblas, opencv, protobuf\nRUN LIBZIP_VERSION=1.1.3 \\\n && wget -q -O - http://nih.at/libzip/libzip-${LIBZIP_VERSION}.tar.gz | tar -xzf - \\\n && cd libzip-${LIBZIP_VERSION} \\\n && ./configure --prefix=/usr/local \\\n && make -j\"$( nproc ;)\" install \\\n && ldconfig /usr/local/lib \\\n && cd .. \\\n && rm -rf /libzip-${LIBZIP_VERSION} \\\n && BOOST_VERSION=1_60_0 \\\n && BOOST_DOTTED_VERSION=$( echo $BOOST_VERSION | tr _ . ;) \\\n && wget -q -O - https://sourceforge.net/projects/boost/files/boost/${BOOST_DOTTED_VERSION}/boost_${BOOST_VERSION}.tar.gz/download | tar -xzf - \\\n && cd boost_${BOOST_VERSION} \\\n && ./bootstrap.sh --prefix=/usr/local --with-libraries=filesystem,system,test \\\n && ./b2 -d0 -j\"$( nproc ;)\" install \\\n && ldconfig /usr/local/lib \\\n && cd .. \\\n && rm -rf /boost_${BOOST_VERSION} \\\n && OPENBLAS_VERSION=0.2.19 \\\n && wget -q -O - https://github.com/xianyi/OpenBLAS/archive/v${OPENBLAS_VERSION}.tar.gz | tar -xzf - \\\n && cd OpenBLAS-${OPENBLAS_VERSION} \\\n && make -j\"$( nproc ;)\" USE_OPENMP=1 | tee make.log \\\n && grep -qF 'OpenBLAS build complete. (BLAS CBLAS LAPACK LAPACKE)' make.log \\\n && grep -qF 'Use OpenMP in the multithreading.' make.log \\\n && make PREFIX=/usr/local/openblas install \\\n && ldconfig /usr/local/openblas \\\n && cd .. \\\n && rm -rf /OpenBLAS-${OPENBLAS_VERSION} \\\n && OPENCV_VERSION=3.1.0 \\\n && wget -q -O - https://github.com/opencv/opencv/archive/${OPENCV_VERSION}.tar.gz | tar -xzf - \\\n && cd opencv-${OPENCV_VERSION} \\\n && cmake -DWITH_CUDA=OFF -DCMAKE_BUILD_TYPE=RELEASE -DCMAKE_INSTALL_PREFIX=/usr/local/opencv-${OPENCV_VERSION} . \\\n && make -j\"$( nproc ;)\" install \\\n && ldconfig /usr/local/lib \\\n && cd .. \\\n && rm -rf /opencv-${OPENCV_VERSION} \\\n && PROTOBUF_VERSION=3.1.0 PROTOBUF_STRING=protobuf-$PROTOBUF_VERSION \\\n && wget -O - --no-verbose https://github.com/google/protobuf/archive/v${PROTOBUF_VERSION}.tar.gz | tar -xzf - \\\n && cd $PROTOBUF_STRING \\\n && ./autogen.sh \\\n && ./configure CFLAGS=-fPIC CXXFLAGS=-fPIC --disable-shared --prefix=/usr/local/$PROTOBUF_STRING \\\n && make -j $( nproc ;) install \\\n && cd .. \\\n && rm -rf $PROTOBUF_STRING\n#   set env vars\nENV KALDI_VERSION=\"c024e8aa\"\nENV PATH=\"/root/anaconda3/envs/cntk-py36/bin:/usr/local/bin:/cntk/build-mkl/cpu/release/bin:${PATH}\" \\\n    KALDI_PATH=\"/usr/local/kaldi-$KALDI_VERSION\" \\\n    BLAS=\"/usr/local/openblas/lib/libopenblas.so\" \\\n    LAPACK=\"/usr/local/openblas/lib/libopenblas.so\" \\\n    MKL_PATH=\"/usr/local/CNTKCustomMKL\" \\\n    PYTHONPATH=\"/cntk/bindings/python:$PYTHONPATH\" \\\n    LD_LIBRARY_PATH=\"/usr/local/openblas/lib:/cntk/bindings/python/cntk/libs:$LD_LIBRARY_PATH\"\n#   install cntk custom mkl, kaldi, swig and anaconda\nRUN CNTK_CUSTOM_MKL_VERSION=3 \\\n && mkdir ${MKL_PATH} \\\n && wget --no-verbose -O - https://www.cntk.ai/mkl/CNTKCustomMKL-Linux-$CNTK_CUSTOM_MKL_VERSION.tgz | tar -xzf - -C ${MKL_PATH} \\\n && mkdir $KALDI_PATH \\\n && wget --no-verbose -O - https://github.com/kaldi-asr/kaldi/archive/$KALDI_VERSION.tar.gz | tar -xzf - --strip-components=1 -C $KALDI_PATH \\\n && cd $KALDI_PATH/tools \\\n && perl -pi -e 's/^# (OPENFST_VERSION = 1.4.1)$/\\1/' Makefile \\\n && make -j $( nproc ;) sph2pipe atlas sclite openfst \\\n && cd ../src \\\n && ./configure --openblas-root=/usr/local/openblas --shared \\\n && make -j $( nproc ;) depend \\\n && make -j $( nproc ;) all \\\n && find $KALDI_PATH -name '*.o' -print0 | xargs -0 rm \\\n && for dir in $KALDI_PATH/src/*bin; do make -C $dir clean ; done \\\n && SWIG_VERSION=3.0.10 \\\n && cd /root \\\n && wget -q http://prdownloads.sourceforge.net/swig/swig-${SWIG_VERSION}.tar.gz -O - | tar xvfz - \\\n && cd swig-${SWIG_VERSION} \\\n && ./configure --without-alllang \\\n && make -j$( nproc ;) \\\n && make install \\\n && cd .. \\\n && rm -rf swig-${SWIG_VERSION} \\\n && wget -q https://repo.continuum.io/archive/Anaconda3-4.4.0-Linux-x86_64.sh \\\n && bash Anaconda3-4.4.0-Linux-x86_64.sh -b \\\n && rm -f Anaconda3-4.4.0-Linux-x86_64.sh \\\n && ldconfig /usr/local/lib\n#   set cntk dir\nWORKDIR /cntk\n#   add intel mpi library and build cntk\nENV MANPATH=\"/usr/share/man:/usr/local/man\" \\\n    COMPILERVARS_ARCHITECTURE=\"intel64\" \\\n    COMPILERVARS_PLATFORM=\"linux\" \\\n    INTEL_MPI_PATH=\"/opt/intel/compilers_and_libraries/linux/mpi\"\nADD l_mpi_2017.2.174.tgz /tmp\nCOPY USE_SERVER.lic /tmp/l_mpi_2017.2.174/\nRUN sed -i -e 's/^ACCEPT_EULA=decline/ACCEPT_EULA=accept/g' /tmp/l_mpi_2017.2.174/silent.cfg \\\n && sed -i -e 's|^#ACTIVATION_LICENSE_FILE=|ACTIVATION_LICENSE_FILE=/tmp/l_mpi_2017.2.174/USE_SERVER.lic|g' /tmp/l_mpi_2017.2.174/silent.cfg \\\n && sed -i -e 's/^ACTIVATION_TYPE=exist_lic/ACTIVATION_TYPE=license_server/g' /tmp/l_mpi_2017.2.174/silent.cfg \\\n && cd /tmp/l_mpi_2017.2.174 \\\n && ./install.sh -s silent.cfg \\\n && cd .. \\\n && rm -rf l_mpi_2017.2.174 \\\n && ln -s ${INTEL_MPI_PATH}/${COMPILERVARS_ARCHITECTURE}/bin/mpicxx ${INTEL_MPI_PATH}/${COMPILERVARS_ARCHITECTURE}/bin/mpic++ \\\n && CNTK_VERSION=v2.1 \\\n && cd /cntk \\\n && git clone --depth=1 --recursive -b ${CNTK_VERSION} --single-branch https://github.com/Microsoft/CNTK.git . \\\n && /root/anaconda3/bin/conda env create -p /root/anaconda3/envs/cntk-py36/ --file /cntk/Scripts/install/linux/conda-linux-cntk-py36-environment.yml \\\n && . /opt/intel/bin/compilervars.sh \\\n && . /opt/intel/compilers_and_libraries/linux/mpi/bin64/mpivars.sh \\\n && CONFIGURE_OPTS=\" --1bitsgd=yes --with-mpi=${INTEL_MPI_PATH}/${COMPILERVARS_ARCHITECTURE} --with-kaldi=${KALDI_PATH} --with-py36-path=/root/anaconda3/envs/cntk-py36\" \\\n && mkdir -p build-mkl/cpu/release \\\n && cd build-mkl/cpu/release \\\n && ../../../configure $CONFIGURE_OPTS --with-mkl=${MKL_PATH} \\\n && make -j\"$( nproc ;)\" all \\\n && rm -rf /cntk/build-mkl/cpu/release/.build \\\n && rm -rf /cntk/.git \\\n && /root/anaconda3/bin/conda clean --all --yes \\\n && echo \"source /root/anaconda3/bin/activate /root/anaconda3/envs/cntk-py36\" > /cntk/activate-cntk \\\n && echo \"source /cntk/activate-cntk\" >> /root/.bashrc \\\n && echo LD_LIBRARY_PATH=${LD_LIBRARY_PATH}:'$LD_LIBRARY_PATH' >> /root/.bashrc \\\n && rm -rf /opt/intel\n#   set sshd command\nEXPOSE 23/tcp\nCMD [\"/usr/sbin/sshd\", \"-D\", \"-p\", \"23\"]\n#   copy in intel mpirun helper script on Batch\nCOPY run_cntk.sh /cntk/\n","originalDockerfileUglifiedHash":"252be531a58dc3bd6583ce5134ba2c48","fileName":"/ICSME-replicationpackage/dataset/smelly_dockerfiles_bianncle/5c362cc66558626070b377dc40b550d72555a6f4.dockerfile"}