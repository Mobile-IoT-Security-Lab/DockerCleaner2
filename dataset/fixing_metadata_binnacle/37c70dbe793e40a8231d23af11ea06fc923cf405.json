{"seed":823336723,"processedDockerfileHash":"bee8358a4b7324a2b918c5f34e3ef65f","fixedSmells":["use-no-install-recommends","do-not-use-apt-get-update-alone","pin-package-manager-versions-apt-get","pin-package-manager-versions-pip","pin-package-manager-versions-npm","pin-package-manager-versions-gem","pin-package-manager-versions-apk","use-copy-instead-of-add","use-wget-instead-of-add","do-not-have-secrets","have-a-healthcheck","have-a-user"],"successfullyFixedSmells":["use-no-install-recommends","do-not-use-apt-get-update-alone","pin-package-manager-versions-apt-get","use-copy-instead-of-add","have-a-healthcheck","have-a-user"],"processedDockerfile":"#\n#   Dockerfile to build a MISP (https://github.com/MISP/MISP) container\n#\n#   Original docker file by eg5846 (https://github.com/eg5846)\n#\n#   2016/03/03 - First release\n#   2017/06/02 - Updated\n#   2018/04/04 - Added objects templates\n#   \n#   We are based on Ubuntu:latest\nFROM ubuntu:xenial\nMAINTAINER Xavier Mertens <xavier@rootshell.be>\n#   Install core components\nENV DEBIAN_FRONTEND=\"noninteractive\"\nRUN : \\\n && apt-get dist-upgrade -y \\\n && apt-get autoremove -y \\\n && apt-get clean\nRUN (apt-get update ;apt-get install --no-install-recommends software-properties-common=0.96.20.10 -y )\nRUN (apt-get update ;apt-get install --no-install-recommends postfix=3.1.0-3ubuntu0.4 -y )\nRUN (apt-get update ;apt-get install --no-install-recommends mysql-client=5.7.33-0ubuntu0.16.04.1 curl=7.47.0-1ubuntu2.19 gcc=4:5.3.1-1ubuntu1 git=1:2.7.4-0ubuntu1.10 gnupg-agent=2.1.11-6ubuntu2.1 make=4.1-6 python=2.7.12-1~16.04 openssl=1.0.2g-1ubuntu4.20 redis-server=2:3.0.6-1ubuntu0.4 sudo=1.8.16-0ubuntu1.10 vim=2:7.4.1689-3ubuntu1.5 zip=3.0-11 locales=2.23-0ubuntu11.3 -y )\nRUN locale-gen en_US.UTF-8\nENV LANG=\"en_US.UTF-8\"\nRUN add-apt-repository -y ppa:ondrej/php \\\n && :\n#   Apache\nRUN (apt-get update ;apt-get install --no-install-recommends apache2=2.4.18-2ubuntu3.17 apache2-doc=2.4.18-2ubuntu3.17 apache2-utils=2.4.18-2ubuntu3.17 -y )\nRUN a2dismod status\nRUN a2dissite 000-default\n#   PHP 7.2\nRUN (apt-get update ;apt-get install --no-install-recommends libapache2-mod-php=1:7.0+35ubuntu6.1 php7.2 php7.2-cli php-crypt-gpg=1.4.0-1ubuntu2 php7.2-dev php7.2-json php7.2-mysql php7.2-opcache php7.2-readline php7.2-redis php7.2-xml -y )\nRUN (apt-get update ;apt-get install --no-install-recommends php-pear=1:1.10.1+submodules+notgz-6ubuntu0.3 pkg-config=0.29.1-0ubuntu1 libbson-1.0 libmongoc-1.0-0=1.3.1-1 php-xml=1:7.0+35ubuntu6.1 php-dev=1:7.0+35ubuntu6.1 -y )\n#   Fix php.ini with recommended settings\nRUN sed -i \"s/max_execution_time = 30/max_execution_time = 300/\" /etc/php/7.2/apache2/php.ini\nRUN sed -i \"s/memory_limit = 128M/memory_limit = 512M/\" /etc/php/7.2/apache2/php.ini\nRUN sed -i \"s/upload_max_filesize = 2M/upload_max_filesize = 50M/\" /etc/php/7.2/apache2/php.ini\nRUN sed -i \"s/post_max_size = 8M/post_max_size = 50M/\" /etc/php/7.2/apache2/php.ini\nRUN (apt-get update ;apt-get install --no-install-recommends python-dev=2.7.12-1~16.04 python-pip=8.1.1-2ubuntu0.6 libxml2-dev=2.9.3+dfsg1-1ubuntu0.7 libxslt1-dev=1.1.28-2.1ubuntu0.3 zlib1g-dev=1:1.2.8.dfsg-2ubuntu4.3 python-setuptools=20.7.0-1 -y )\nRUN (apt-get update ;apt-get install --no-install-recommends cron=3.0pl1-128ubuntu2 logrotate=3.8.7-2ubuntu2.16.04.2 supervisor=3.2.0-2ubuntu0.2 syslog-ng-core=3.5.6-2.1 -y )\nRUN apt-get clean\nWORKDIR /var/www\nRUN chown www-data:www-data /var/www\nUSER www-data\nRUN git clone https://github.com/MISP/MISP.git\nWORKDIR /var/www/MISP\nRUN git checkout tags/$( git describe --tags `git rev-list --tags --max-count=1 ` ;)\nRUN git config core.filemode false\nWORKDIR /var/www/MISP/app/files/scripts\nRUN git clone https://github.com/CybOXProject/python-cybox.git\nRUN git clone https://github.com/STIXProject/python-stix.git\nWORKDIR /var/www/MISP/app/files/scripts/python-cybox\nRUN git checkout v2.1.0.12\nUSER root\nRUN python setup.py install\nUSER www-data\nWORKDIR /var/www/MISP/app/files/scripts/python-stix\nRUN git checkout v1.1.1.4\nUSER root\nRUN python setup.py install\nUSER www-data\nWORKDIR /var/www/MISP\nRUN git submodule init\nRUN git submodule update\nWORKDIR /var/www/MISP/app\nRUN php composer.phar config vendor-dir Vendor\nRUN php composer.phar install --ignore-platform-reqs\nUSER root\nRUN phpenmod redis\nUSER www-data\nRUN cp -fa /var/www/MISP/INSTALL/setup/config.php /var/www/MISP/app/Plugin/CakeResque/Config/config.php\n#   Fix permissions\nUSER root\nRUN chown -R www-data:www-data /var/www/MISP\nRUN chmod -R 750 /var/www/MISP\nRUN chmod -R g+ws /var/www/MISP/app/tmp\nRUN chmod -R g+ws /var/www/MISP/app/files\nRUN chmod -R g+ws /var/www/MISP/app/files/scripts/tmp\nRUN cp /var/www/MISP/INSTALL/misp.logrotate /etc/logrotate.d/misp\n#   Preconfigure setting for packages\nRUN echo \"postfix postfix/main_mailer_type string Local only\" | debconf-set-selections\nRUN echo \"postfix postfix/mailname string localhost.localdomain\" | debconf-set-selections\n#   Redis Setup\nRUN sed -i 's/^\\(daemonize\\s*\\)yes\\s*$/\\1no/g' /etc/redis/redis.conf\n#   Install PEAR packages\nRUN pear install Crypt_GPG >> /tmp/install.log\nRUN pear install Net_GeoIP >> /tmp/install.log\n#   Apache Setup\nRUN cp /var/www/MISP/INSTALL/apache.misp.ubuntu /etc/apache2/sites-available/misp.conf\nRUN a2dissite 000-default\nRUN a2ensite misp\nRUN a2enmod rewrite\nRUN a2enmod headers\n#   MISP base configuration\nRUN sudo -u www-data cp -a /var/www/MISP/app/Config/bootstrap.default.php /var/www/MISP/app/Config/bootstrap.php\nRUN sudo -u www-data cp -a /var/www/MISP/app/Config/database.default.php /var/www/MISP/app/Config/database.php\nRUN sudo -u www-data cp -a /var/www/MISP/app/Config/core.default.php /var/www/MISP/app/Config/core.php\nRUN sudo -u www-data cp -a /var/www/MISP/app/Config/config.default.php /var/www/MISP/app/Config/config.php\nRUN chown -R www-data:www-data /var/www/MISP/app/Config\nRUN chmod -R 750 /var/www/MISP/app/Config\n#   Replace the default salt\nRUN sed -i -E \"s/'salt'\\s=>\\s'(\\S+)'/'salt' => '`openssl rand -base64 32 | tr \"/\" \"-\" `'/\" /var/www/MISP/app/Config/config.php\n#   Enable workers at boot time\nRUN chmod a+x /var/www/MISP/app/Console/worker/start.sh\nRUN echo \"sudo -u www-data bash /var/www/MISP/app/Console/worker/start.sh\" >> /etc/rc.local\n#   Install templates & stuff\nWORKDIR /var/www/MISP/app/files\nRUN git clone https://github.com/MISP/misp-objects.git\nRUN git clone https://github.com/MISP/misp-galaxy.git\nRUN git clone https://github.com/MISP/misp-warninglists.git ./warninglists\nRUN git clone https://github.com/MISP/misp-taxonomies.git ./taxonomies\nRUN chown -R www-data:www-data misp-objects misp-galaxy warninglists taxonomies\n#   Install MISP Modules\nWORKDIR /opt\nRUN (apt-get update ;apt-get install --no-install-recommends python3=3.5.1-3 python3-pip=8.1.1-2ubuntu0.6 libjpeg-dev=8c-2ubuntu8 -y )\nRUN git clone https://github.com/MISP/misp-modules.git\nWORKDIR /opt/misp-modules\nRUN pip3 install --upgrade --ignore-installed urllib3\nRUN pip3 install --upgrade --ignore-installed requests\nRUN pip3 install -I -r REQUIREMENTS\nRUN pip3 install -I .\nRUN echo \"sudo -u www-data misp-modules -s &\" >> /etc/rc.local\n#   Supervisord Setup\nRUN echo '[supervisord]' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'nodaemon = true' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '[program:postfix]' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'process_name = master' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'directory = /etc/postfix' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'command = /usr/sbin/postfix -c /etc/postfix start' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'startsecs = 0' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'autorestart = false' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '[program:redis-server]' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'command=redis-server /etc/redis/redis.conf' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '[program:apache2]' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'command=/bin/bash -c \"source /etc/apache2/envvars \\\n && exec /usr/sbin/apache2 -D FOREGROUND\"' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '[program:resque]' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'command=/bin/bash /var/www/MISP/app/Console/worker/start.sh' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'user = www-data' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'startsecs = 0' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'autorestart = false' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '[program:misp-modules]' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'command=/bin/bash -c \"cd /opt/misp-modules/bin \\\n && /usr/bin/python3 misp-modules.py\"' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'user = root' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'startsecs = 0' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'autorestart = false' >> /etc/supervisor/conf.d/supervisord.conf\n#   Modify syslog configuration\nRUN sed -i -E 's/^(\\s*)system\\(\\);/\\1unix-stream(\"\\/dev\\/log\");/' /etc/syslog-ng/syslog-ng.conf\n#   Add run script\nCOPY run.sh /run.sh\nRUN chmod 0755 /run.sh\n#   Trigger to perform first boot operations\nRUN touch /.firstboot.tmp\n#   Make a backup of /var/www/MISP to restore it to the local moint point at first boot\nWORKDIR /var/www/MISP\nRUN tar czpf /root/MISP.tgz .\nVOLUME /var/www/MISP\nEXPOSE 80/tcp\nENTRYPOINT [\"/run.sh\"]\nRUN groupadd --system docker-user ; useradd --system --gid docker-user docker-user\nUSER docker-user\n# Please add your HEALTHCHECK here!!!\n","originalDockerfile":"#\n#  Dockerfile to build a MISP (https://github.com/MISP/MISP) container\n#\n#  Original docker file by eg5846 (https://github.com/eg5846)\n#\n#  2016/03/03 - First release\n#  2017/06/02 - Updated\n#  2018/04/04 - Added objects templates\n#  \n#  We are based on Ubuntu:latest\nFROM ubuntu:xenial\nMAINTAINER Xavier Mertens <xavier@rootshell.be>\n#  Install core components\nENV DEBIAN_FRONTEND=\"noninteractive\"\nRUN apt-get update \\\n && apt-get dist-upgrade -y \\\n && apt-get autoremove -y \\\n && apt-get clean\nRUN apt-get install software-properties-common -y\nRUN apt-get install postfix -y\nRUN apt-get install mysql-client curl gcc git gnupg-agent make python openssl redis-server sudo vim zip locales -y\nRUN locale-gen en_US.UTF-8\nENV LANG=\"en_US.UTF-8\"\nRUN add-apt-repository -y ppa:ondrej/php \\\n && apt-get update\n#  Apache\nRUN apt-get install apache2 apache2-doc apache2-utils -y\nRUN a2dismod status\nRUN a2dissite 000-default\n#  PHP 7.2\nRUN apt-get install libapache2-mod-php php7.2 php7.2-cli php-crypt-gpg php7.2-dev php7.2-json php7.2-mysql php7.2-opcache php7.2-readline php7.2-redis php7.2-xml -y\nRUN apt-get install php-pear pkg-config libbson-1.0 libmongoc-1.0-0 php-xml php-dev -y\n#  Fix php.ini with recommended settings\nRUN sed -i \"s/max_execution_time = 30/max_execution_time = 300/\" /etc/php/7.2/apache2/php.ini\nRUN sed -i \"s/memory_limit = 128M/memory_limit = 512M/\" /etc/php/7.2/apache2/php.ini\nRUN sed -i \"s/upload_max_filesize = 2M/upload_max_filesize = 50M/\" /etc/php/7.2/apache2/php.ini\nRUN sed -i \"s/post_max_size = 8M/post_max_size = 50M/\" /etc/php/7.2/apache2/php.ini\nRUN apt-get install python-dev python-pip libxml2-dev libxslt1-dev zlib1g-dev python-setuptools -y\nRUN apt-get install cron logrotate supervisor syslog-ng-core -y\nRUN apt-get clean\nWORKDIR /var/www\nRUN chown www-data:www-data /var/www\nUSER www-data\nRUN git clone https://github.com/MISP/MISP.git\nWORKDIR /var/www/MISP\nRUN git checkout tags/$( git describe --tags `git rev-list --tags --max-count=1 ` ;)\nRUN git config core.filemode false\nWORKDIR /var/www/MISP/app/files/scripts\nRUN git clone https://github.com/CybOXProject/python-cybox.git\nRUN git clone https://github.com/STIXProject/python-stix.git\nWORKDIR /var/www/MISP/app/files/scripts/python-cybox\nRUN git checkout v2.1.0.12\nUSER root\nRUN python setup.py install\nUSER www-data\nWORKDIR /var/www/MISP/app/files/scripts/python-stix\nRUN git checkout v1.1.1.4\nUSER root\nRUN python setup.py install\nUSER www-data\nWORKDIR /var/www/MISP\nRUN git submodule init\nRUN git submodule update\nWORKDIR /var/www/MISP/app\nRUN php composer.phar config vendor-dir Vendor\nRUN php composer.phar install --ignore-platform-reqs\nUSER root\nRUN phpenmod redis\nUSER www-data\nRUN cp -fa /var/www/MISP/INSTALL/setup/config.php /var/www/MISP/app/Plugin/CakeResque/Config/config.php\n#  Fix permissions\nUSER root\nRUN chown -R www-data:www-data /var/www/MISP\nRUN chmod -R 750 /var/www/MISP\nRUN chmod -R g+ws /var/www/MISP/app/tmp\nRUN chmod -R g+ws /var/www/MISP/app/files\nRUN chmod -R g+ws /var/www/MISP/app/files/scripts/tmp\nRUN cp /var/www/MISP/INSTALL/misp.logrotate /etc/logrotate.d/misp\n#  Preconfigure setting for packages\nRUN echo \"postfix postfix/main_mailer_type string Local only\" | debconf-set-selections\nRUN echo \"postfix postfix/mailname string localhost.localdomain\" | debconf-set-selections\n#  Redis Setup\nRUN sed -i 's/^\\(daemonize\\s*\\)yes\\s*$/\\1no/g' /etc/redis/redis.conf\n#  Install PEAR packages\nRUN pear install Crypt_GPG >> /tmp/install.log\nRUN pear install Net_GeoIP >> /tmp/install.log\n#  Apache Setup\nRUN cp /var/www/MISP/INSTALL/apache.misp.ubuntu /etc/apache2/sites-available/misp.conf\nRUN a2dissite 000-default\nRUN a2ensite misp\nRUN a2enmod rewrite\nRUN a2enmod headers\n#  MISP base configuration\nRUN sudo -u www-data cp -a /var/www/MISP/app/Config/bootstrap.default.php /var/www/MISP/app/Config/bootstrap.php\nRUN sudo -u www-data cp -a /var/www/MISP/app/Config/database.default.php /var/www/MISP/app/Config/database.php\nRUN sudo -u www-data cp -a /var/www/MISP/app/Config/core.default.php /var/www/MISP/app/Config/core.php\nRUN sudo -u www-data cp -a /var/www/MISP/app/Config/config.default.php /var/www/MISP/app/Config/config.php\nRUN chown -R www-data:www-data /var/www/MISP/app/Config\nRUN chmod -R 750 /var/www/MISP/app/Config\n#  Replace the default salt\nRUN sed -i -E \"s/'salt'\\s=>\\s'(\\S+)'/'salt' => '`openssl rand -base64 32 | tr \"/\" \"-\" `'/\" /var/www/MISP/app/Config/config.php\n#  Enable workers at boot time\nRUN chmod a+x /var/www/MISP/app/Console/worker/start.sh\nRUN echo \"sudo -u www-data bash /var/www/MISP/app/Console/worker/start.sh\" >> /etc/rc.local\n#  Install templates & stuff\nWORKDIR /var/www/MISP/app/files\nRUN git clone https://github.com/MISP/misp-objects.git\nRUN git clone https://github.com/MISP/misp-galaxy.git\nRUN git clone https://github.com/MISP/misp-warninglists.git ./warninglists\nRUN git clone https://github.com/MISP/misp-taxonomies.git ./taxonomies\nRUN chown -R www-data:www-data misp-objects misp-galaxy warninglists taxonomies\n#  Install MISP Modules\nWORKDIR /opt\nRUN apt-get install python3 python3-pip libjpeg-dev -y\nRUN git clone https://github.com/MISP/misp-modules.git\nWORKDIR /opt/misp-modules\nRUN pip3 install --upgrade --ignore-installed urllib3\nRUN pip3 install --upgrade --ignore-installed requests\nRUN pip3 install -I -r REQUIREMENTS\nRUN pip3 install -I .\nRUN echo \"sudo -u www-data misp-modules -s &\" >> /etc/rc.local\n#  Supervisord Setup\nRUN echo '[supervisord]' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'nodaemon = true' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '[program:postfix]' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'process_name = master' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'directory = /etc/postfix' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'command = /usr/sbin/postfix -c /etc/postfix start' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'startsecs = 0' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'autorestart = false' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '[program:redis-server]' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'command=redis-server /etc/redis/redis.conf' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '[program:apache2]' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'command=/bin/bash -c \"source /etc/apache2/envvars \\\n && exec /usr/sbin/apache2 -D FOREGROUND\"' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '[program:resque]' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'command=/bin/bash /var/www/MISP/app/Console/worker/start.sh' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'user = www-data' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'startsecs = 0' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'autorestart = false' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '[program:misp-modules]' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'command=/bin/bash -c \"cd /opt/misp-modules/bin \\\n && /usr/bin/python3 misp-modules.py\"' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'user = root' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'startsecs = 0' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'autorestart = false' >> /etc/supervisor/conf.d/supervisord.conf\n#  Modify syslog configuration\nRUN sed -i -E 's/^(\\s*)system\\(\\);/\\1unix-stream(\"\\/dev\\/log\");/' /etc/syslog-ng/syslog-ng.conf\n#  Add run script\nADD run.sh /run.sh\nRUN chmod 0755 /run.sh\n#  Trigger to perform first boot operations\nRUN touch /.firstboot.tmp\n#  Make a backup of /var/www/MISP to restore it to the local moint point at first boot\nWORKDIR /var/www/MISP\nRUN tar czpf /root/MISP.tgz .\nVOLUME /var/www/MISP\nEXPOSE 80/tcp\nENTRYPOINT [\"/run.sh\"]\n","injectedSmells":[],"originalDockerfileHash":"e14bafc1bb62c8ddc4255d8d31131f13","successfullyInjectedSmells":[],"originalDockerfileUglified":"#\n#   Dockerfile to build a MISP (https://github.com/MISP/MISP) container\n#\n#   Original docker file by eg5846 (https://github.com/eg5846)\n#\n#   2016/03/03 - First release\n#   2017/06/02 - Updated\n#   2018/04/04 - Added objects templates\n#   \n#   We are based on Ubuntu:latest\nFROM ubuntu:xenial\nMAINTAINER Xavier Mertens <xavier@rootshell.be>\n#   Install core components\nENV DEBIAN_FRONTEND=\"noninteractive\"\nRUN apt-get update \\\n && apt-get dist-upgrade -y \\\n && apt-get autoremove -y \\\n && apt-get clean\nRUN apt-get install software-properties-common -y\nRUN apt-get install postfix -y\nRUN apt-get install mysql-client curl gcc git gnupg-agent make python openssl redis-server sudo vim zip locales -y\nRUN locale-gen en_US.UTF-8\nENV LANG=\"en_US.UTF-8\"\nRUN add-apt-repository -y ppa:ondrej/php \\\n && apt-get update\n#   Apache\nRUN apt-get install apache2 apache2-doc apache2-utils -y\nRUN a2dismod status\nRUN a2dissite 000-default\n#   PHP 7.2\nRUN apt-get install libapache2-mod-php php7.2 php7.2-cli php-crypt-gpg php7.2-dev php7.2-json php7.2-mysql php7.2-opcache php7.2-readline php7.2-redis php7.2-xml -y\nRUN apt-get install php-pear pkg-config libbson-1.0 libmongoc-1.0-0 php-xml php-dev -y\n#   Fix php.ini with recommended settings\nRUN sed -i \"s/max_execution_time = 30/max_execution_time = 300/\" /etc/php/7.2/apache2/php.ini\nRUN sed -i \"s/memory_limit = 128M/memory_limit = 512M/\" /etc/php/7.2/apache2/php.ini\nRUN sed -i \"s/upload_max_filesize = 2M/upload_max_filesize = 50M/\" /etc/php/7.2/apache2/php.ini\nRUN sed -i \"s/post_max_size = 8M/post_max_size = 50M/\" /etc/php/7.2/apache2/php.ini\nRUN apt-get install python-dev python-pip libxml2-dev libxslt1-dev zlib1g-dev python-setuptools -y\nRUN apt-get install cron logrotate supervisor syslog-ng-core -y\nRUN apt-get clean\nWORKDIR /var/www\nRUN chown www-data:www-data /var/www\nUSER www-data\nRUN git clone https://github.com/MISP/MISP.git\nWORKDIR /var/www/MISP\nRUN git checkout tags/$( git describe --tags `git rev-list --tags --max-count=1 ` ;)\nRUN git config core.filemode false\nWORKDIR /var/www/MISP/app/files/scripts\nRUN git clone https://github.com/CybOXProject/python-cybox.git\nRUN git clone https://github.com/STIXProject/python-stix.git\nWORKDIR /var/www/MISP/app/files/scripts/python-cybox\nRUN git checkout v2.1.0.12\nUSER root\nRUN python setup.py install\nUSER www-data\nWORKDIR /var/www/MISP/app/files/scripts/python-stix\nRUN git checkout v1.1.1.4\nUSER root\nRUN python setup.py install\nUSER www-data\nWORKDIR /var/www/MISP\nRUN git submodule init\nRUN git submodule update\nWORKDIR /var/www/MISP/app\nRUN php composer.phar config vendor-dir Vendor\nRUN php composer.phar install --ignore-platform-reqs\nUSER root\nRUN phpenmod redis\nUSER www-data\nRUN cp -fa /var/www/MISP/INSTALL/setup/config.php /var/www/MISP/app/Plugin/CakeResque/Config/config.php\n#   Fix permissions\nUSER root\nRUN chown -R www-data:www-data /var/www/MISP\nRUN chmod -R 750 /var/www/MISP\nRUN chmod -R g+ws /var/www/MISP/app/tmp\nRUN chmod -R g+ws /var/www/MISP/app/files\nRUN chmod -R g+ws /var/www/MISP/app/files/scripts/tmp\nRUN cp /var/www/MISP/INSTALL/misp.logrotate /etc/logrotate.d/misp\n#   Preconfigure setting for packages\nRUN echo \"postfix postfix/main_mailer_type string Local only\" | debconf-set-selections\nRUN echo \"postfix postfix/mailname string localhost.localdomain\" | debconf-set-selections\n#   Redis Setup\nRUN sed -i 's/^\\(daemonize\\s*\\)yes\\s*$/\\1no/g' /etc/redis/redis.conf\n#   Install PEAR packages\nRUN pear install Crypt_GPG >> /tmp/install.log\nRUN pear install Net_GeoIP >> /tmp/install.log\n#   Apache Setup\nRUN cp /var/www/MISP/INSTALL/apache.misp.ubuntu /etc/apache2/sites-available/misp.conf\nRUN a2dissite 000-default\nRUN a2ensite misp\nRUN a2enmod rewrite\nRUN a2enmod headers\n#   MISP base configuration\nRUN sudo -u www-data cp -a /var/www/MISP/app/Config/bootstrap.default.php /var/www/MISP/app/Config/bootstrap.php\nRUN sudo -u www-data cp -a /var/www/MISP/app/Config/database.default.php /var/www/MISP/app/Config/database.php\nRUN sudo -u www-data cp -a /var/www/MISP/app/Config/core.default.php /var/www/MISP/app/Config/core.php\nRUN sudo -u www-data cp -a /var/www/MISP/app/Config/config.default.php /var/www/MISP/app/Config/config.php\nRUN chown -R www-data:www-data /var/www/MISP/app/Config\nRUN chmod -R 750 /var/www/MISP/app/Config\n#   Replace the default salt\nRUN sed -i -E \"s/'salt'\\s=>\\s'(\\S+)'/'salt' => '`openssl rand -base64 32 | tr \"/\" \"-\" `'/\" /var/www/MISP/app/Config/config.php\n#   Enable workers at boot time\nRUN chmod a+x /var/www/MISP/app/Console/worker/start.sh\nRUN echo \"sudo -u www-data bash /var/www/MISP/app/Console/worker/start.sh\" >> /etc/rc.local\n#   Install templates & stuff\nWORKDIR /var/www/MISP/app/files\nRUN git clone https://github.com/MISP/misp-objects.git\nRUN git clone https://github.com/MISP/misp-galaxy.git\nRUN git clone https://github.com/MISP/misp-warninglists.git ./warninglists\nRUN git clone https://github.com/MISP/misp-taxonomies.git ./taxonomies\nRUN chown -R www-data:www-data misp-objects misp-galaxy warninglists taxonomies\n#   Install MISP Modules\nWORKDIR /opt\nRUN apt-get install python3 python3-pip libjpeg-dev -y\nRUN git clone https://github.com/MISP/misp-modules.git\nWORKDIR /opt/misp-modules\nRUN pip3 install --upgrade --ignore-installed urllib3\nRUN pip3 install --upgrade --ignore-installed requests\nRUN pip3 install -I -r REQUIREMENTS\nRUN pip3 install -I .\nRUN echo \"sudo -u www-data misp-modules -s &\" >> /etc/rc.local\n#   Supervisord Setup\nRUN echo '[supervisord]' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'nodaemon = true' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '[program:postfix]' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'process_name = master' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'directory = /etc/postfix' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'command = /usr/sbin/postfix -c /etc/postfix start' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'startsecs = 0' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'autorestart = false' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '[program:redis-server]' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'command=redis-server /etc/redis/redis.conf' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '[program:apache2]' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'command=/bin/bash -c \"source /etc/apache2/envvars \\\n && exec /usr/sbin/apache2 -D FOREGROUND\"' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '[program:resque]' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'command=/bin/bash /var/www/MISP/app/Console/worker/start.sh' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'user = www-data' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'startsecs = 0' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'autorestart = false' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '[program:misp-modules]' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'command=/bin/bash -c \"cd /opt/misp-modules/bin \\\n && /usr/bin/python3 misp-modules.py\"' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'user = root' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'startsecs = 0' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'autorestart = false' >> /etc/supervisor/conf.d/supervisord.conf\n#   Modify syslog configuration\nRUN sed -i -E 's/^(\\s*)system\\(\\);/\\1unix-stream(\"\\/dev\\/log\");/' /etc/syslog-ng/syslog-ng.conf\n#   Add run script\nADD run.sh /run.sh\nRUN chmod 0755 /run.sh\n#   Trigger to perform first boot operations\nRUN touch /.firstboot.tmp\n#   Make a backup of /var/www/MISP to restore it to the local moint point at first boot\nWORKDIR /var/www/MISP\nRUN tar czpf /root/MISP.tgz .\nVOLUME /var/www/MISP\nEXPOSE 80/tcp\nENTRYPOINT [\"/run.sh\"]\n","originalDockerfileUglifiedHash":"409d5d43dd48b81acd38ceb5b3ffb839","fileName":"/ICSME-replicationpackage/dataset/smelly_dockerfiles_bianncle/37c70dbe793e40a8231d23af11ea06fc923cf405.dockerfile"}