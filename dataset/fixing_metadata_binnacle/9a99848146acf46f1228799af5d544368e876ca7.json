{"seed":2577980267,"processedDockerfileHash":"028d247878fb648d57aea02ccbbb3222","fixedSmells":["use-no-install-recommends","do-not-use-apt-get-update-alone","pin-package-manager-versions-apt-get","pin-package-manager-versions-pip","pin-package-manager-versions-npm","pin-package-manager-versions-gem","pin-package-manager-versions-apk","use-copy-instead-of-add","use-wget-instead-of-add","do-not-have-secrets","have-a-healthcheck","have-a-user"],"successfullyFixedSmells":["use-no-install-recommends","use-copy-instead-of-add","have-a-healthcheck","have-a-user"],"processedDockerfile":"FROM debian:stretch-slim\nLABEL maintainer=\"Thomas VIAL\"\nENV DEBIAN_FRONTEND=\"noninteractive\"\nENV VIRUSMAILS_DELETE_DELAY=\"7\"\nENV ONE_DIR=\"0\"\nENV ENABLE_POSTGREY=\"0\"\nENV FETCHMAIL_POLL=\"300\"\nENV POSTGREY_DELAY=\"300\"\nENV POSTGREY_MAX_AGE=\"35\"\nENV POSTGREY_AUTO_WHITELIST_CLIENTS=\"5\"\nENV POSTGREY_TEXT=\"Delayed by postgrey\"\nENV SASLAUTHD_MECHANISMS=\"pam\"\nENV SASLAUTHD_MECH_OPTIONS=\"\"\n#   Packages\nRUN apt-get update -q --fix-missing \\\n && apt-get -y upgrade \\\n && apt-get install --no-install-recommends postfix -y \\\n && apt-get install --no-install-recommends amavisd-new arj binutils bzip2 ca-certificates cabextract clamav clamav-daemon cpio curl ed fail2ban fetchmail file gamin gzip gnupg iproute2 iptables locales liblz4-tool libmail-spf-perl libnet-dns-perl libsasl2-modules lrzip lzop netcat-openbsd nomarch opendkim opendkim-tools opendmarc pax pflogsumm p7zip-full postfix-ldap postfix-pcre postfix-policyd-spf-python postsrsd pyzor razor ripole rpm2cpio rsyslog sasl2-bin spamassassin supervisor postgrey unrar-free unzip xz-utils zoo -y \\\n && curl https://packages.elasticsearch.org/GPG-KEY-elasticsearch | apt-key add - \\\n && echo \"deb http://packages.elastic.co/beats/apt stable main\" | tee -a /etc/apt/sources.list.d/beats.list \\\n && echo \"deb http://ftp.debian.org/debian stretch-backports main\" | tee -a /etc/apt/sources.list.d/stretch-bp.list \\\n && apt-get update -q --fix-missing \\\n && apt-get -y upgrade filebeat \\\n && apt-get -t stretch-backports -y install --no-install-recommends dovecot-core dovecot-imapd dovecot-ldap dovecot-lmtpd dovecot-managesieved dovecot-pop3d dovecot-sieve \\\n && apt-get autoclean \\\n && rm -rf /var/lib/apt/lists/* \\\n && rm -rf /usr/share/locale/* \\\n && rm -rf /usr/share/man/* \\\n && rm -rf /usr/share/doc/* \\\n && touch /var/log/auth.log \\\n && update-locale \\\n && rm -f /etc/cron.weekly/fstrim \\\n && rm -f /etc/postsrsd.secret\nRUN echo \"0 0,6,12,18 * * * /usr/bin/freshclam --quiet\" > /etc/cron.d/clamav-freshclam \\\n && chmod 644 /etc/clamav/freshclam.conf \\\n && freshclam \\\n && sed -i 's/Foreground false/Foreground true/g' /etc/clamav/clamd.conf \\\n && sed -i 's/AllowSupplementaryGroups false/AllowSupplementaryGroups true/g' /etc/clamav/clamd.conf \\\n && mkdir /var/run/clamav \\\n && chown -R clamav:root /var/run/clamav\n#   Configures Dovecot\nCOPY target/dovecot/auth-passwdfile.inc target/dovecot/??-*.conf /etc/dovecot/conf.d/\nRUN sed -i -e 's/include_try \\/usr\\/share\\/dovecot\\/protocols\\.d/include_try \\/etc\\/dovecot\\/protocols\\.d/g' /etc/dovecot/dovecot.conf \\\n && sed -i -e 's/#mail_plugins = \\$mail_plugins/mail_plugins = \\$mail_plugins sieve/g' /etc/dovecot/conf.d/15-lda.conf \\\n && sed -i -e 's/^.*lda_mailbox_autocreate.*/lda_mailbox_autocreate = yes/g' /etc/dovecot/conf.d/15-lda.conf \\\n && sed -i -e 's/^.*lda_mailbox_autosubscribe.*/lda_mailbox_autosubscribe = yes/g' /etc/dovecot/conf.d/15-lda.conf \\\n && sed -i -e 's/^.*postmaster_address.*/postmaster_address = '${POSTMASTER_ADDRESS:=\"postmaster@domain.com\"}'/g' /etc/dovecot/conf.d/15-lda.conf \\\n && sed -i 's/#imap_idle_notify_interval = 2 mins/imap_idle_notify_interval = 29 mins/' /etc/dovecot/conf.d/20-imap.conf \\\n && mkdir /etc/dovecot/ssl \\\n && chmod 755 /etc/dovecot/ssl \\\n && cd /usr/share/dovecot \\\n && ./mkcert.sh \\\n && mkdir -p /usr/lib/dovecot/sieve-pipe /usr/lib/dovecot/sieve-filter /usr/lib/dovecot/sieve-global \\\n && chmod 755 -R /usr/lib/dovecot/sieve-pipe /usr/lib/dovecot/sieve-filter /usr/lib/dovecot/sieve-global\n#   Configures LDAP\nCOPY target/dovecot/dovecot-ldap.conf.ext /etc/dovecot\nCOPY target/postfix/ldap-users.cf target/postfix/ldap-groups.cf target/postfix/ldap-aliases.cf target/postfix/ldap-domains.cf /etc/postfix/\n#   Enables Spamassassin CRON updates and update hook for supervisor\nRUN sed -i -r 's/^(CRON)=0/\\1=1/g' /etc/default/spamassassin \\\n && sed -i -r 's/^\\$INIT restart/supervisorctl restart amavis/g' /etc/spamassassin/sa-update-hooks.d/amavisd-new\n#   Enables Postgrey\nCOPY target/postgrey/postgrey /etc/default/postgrey\nCOPY target/postgrey/postgrey.init /etc/init.d/postgrey\nRUN chmod 755 /etc/init.d/postgrey \\\n && mkdir /var/run/postgrey \\\n && chown postgrey:postgrey /var/run/postgrey\n#   Copy PostSRSd Config\nCOPY target/postsrsd/postsrsd /etc/default/postsrsd\n#   Enables Amavis\nCOPY target/amavis/conf.d/* /etc/amavis/conf.d/\nRUN sed -i -r 's/#(@| \\\\%)bypass/\\1bypass/g' /etc/amavis/conf.d/15-content_filter_mode \\\n && adduser clamav amavis \\\n && adduser amavis clamav \\\n && adduser --system syslog \\\n && useradd -u 5000 -d /home/docker -s /bin/bash -p $( echo docker | openssl passwd -1 -stdin ;) docker \\\n && (echo \"0 4 * * * /usr/local/bin/virus-wiper\" ;crontab -l ) | crontab -\n#   Configure Fail2ban\nCOPY target/fail2ban/jail.conf /etc/fail2ban/jail.conf\nCOPY target/fail2ban/filter.d/dovecot.conf /etc/fail2ban/filter.d/dovecot.conf\nRUN echo \"ignoreregex =\" >> /etc/fail2ban/filter.d/postfix-sasl.conf \\\n && mkdir /var/run/fail2ban\n#   Enables Pyzor and Razor\nUSER amavis\nRUN razor-admin -create \\\n && razor-admin -register\nUSER root\n#   Configure DKIM (opendkim)\n#   DKIM config files\nCOPY target/opendkim/opendkim.conf /etc/opendkim.conf\nCOPY target/opendkim/default-opendkim /etc/default/opendkim\n#   Configure DMARC (opendmarc)\nCOPY target/opendmarc/opendmarc.conf /etc/opendmarc.conf\nCOPY target/opendmarc/default-opendmarc /etc/default/opendmarc\nCOPY target/opendmarc/ignore.hosts /etc/opendmarc/ignore.hosts\n#   Configure fetchmail\nCOPY target/fetchmail/fetchmailrc /etc/fetchmailrc_general\nRUN sed -i 's/START_DAEMON=no/START_DAEMON=yes/g' /etc/default/fetchmail\nRUN mkdir /var/run/fetchmail \\\n && chown fetchmail /var/run/fetchmail\n#   Configures Postfix\nCOPY target/postfix/main.cf target/postfix/master.cf /etc/postfix/\nCOPY target/postfix/header_checks.pcre target/postfix/sender_header_filter.pcre target/postfix/sender_login_maps.pcre /etc/postfix/maps/\nRUN echo \"\" > /etc/aliases \\\n && openssl dhparam -out /etc/postfix/dhparams.pem 2048 \\\n && echo \"@weekly FILE=`mktemp ` ; openssl dhparam -out $FILE 2048 > /dev/null 2>&1 \\\n && mv -f $FILE /etc/postfix/dhparams.pem\" > /etc/cron.d/dh2048\n#   Configuring Logs\nRUN sed -i -r \"/^#?compress/c\\compress\\ncopytruncate\" /etc/logrotate.conf \\\n && mkdir -p /var/log/mail \\\n && chown syslog:root /var/log/mail \\\n && touch /var/log/mail/clamav.log \\\n && chown -R clamav:root /var/log/mail/clamav.log \\\n && touch /var/log/mail/freshclam.log \\\n && chown -R clamav:root /var/log/mail/freshclam.log \\\n && sed -i -r 's|/var/log/mail|/var/log/mail/mail|g' /etc/rsyslog.conf \\\n && sed -i -r 's|;auth,authpriv.none|;mail.none;mail.error;auth,authpriv.none|g' /etc/rsyslog.conf \\\n && sed -i -r 's|LogFile /var/log/clamav/|LogFile /var/log/mail/|g' /etc/clamav/clamd.conf \\\n && sed -i -r 's|UpdateLogFile /var/log/clamav/|UpdateLogFile /var/log/mail/|g' /etc/clamav/freshclam.conf \\\n && sed -i -r 's|/var/log/clamav|/var/log/mail|g' /etc/logrotate.d/clamav-daemon \\\n && sed -i -r 's|/var/log/clamav|/var/log/mail|g' /etc/logrotate.d/clamav-freshclam \\\n && sed -i -r 's|/var/log/mail|/var/log/mail/mail|g' /etc/logrotate.d/rsyslog \\\n && sed -i -r '/\\/var\\/log\\/mail\\/mail.log/d' /etc/logrotate.d/rsyslog \\\n && sed -i -e 's/\\(printerror \"could not determine current runlevel\"\\)/#\\1/' /usr/sbin/invoke-rc.d \\\n && sed -i -e 's/^\\(POLICYHELPER=\\).*/\\1/' /usr/sbin/invoke-rc.d \\\n && sed -i -e 's/invoke-rc.d rsyslog rotate > \\/dev\\/null/invoke-rc.d rsyslog --quiet rotate > \\/dev\\/null/g' /etc/logrotate.d/rsyslog\n#   Get LetsEncrypt signed certificate\nRUN curl -s https://letsencrypt.org/certs/lets-encrypt-x3-cross-signed.pem > /etc/ssl/certs/lets-encrypt-x3-cross-signed.pem\nCOPY ./target/bin /usr/local/bin\n#   Start-mailserver script\nCOPY ./target/check-for-changes.sh ./target/start-mailserver.sh ./target/fail2ban-wrapper.sh ./target/postfix-wrapper.sh ./target/postsrsd-wrapper.sh ./target/docker-configomat/configomat.sh /usr/local/bin/\nRUN chmod +x /usr/local/bin/*\n#   Configure supervisor\nCOPY target/supervisor/supervisord.conf /etc/supervisor/supervisord.conf\nCOPY target/supervisor/conf.d/* /etc/supervisor/conf.d/\nEXPOSE 25/tcp 587/tcp 143/tcp 465/tcp 993/tcp 110/tcp 995/tcp 4190/tcp\nCMD [\"supervisord\", \"-c\", \"/etc/supervisor/supervisord.conf\"]\nCOPY target/filebeat.yml.tmpl /etc/filebeat/filebeat.yml.tmpl\nRUN groupadd --system docker-user ; useradd --system --gid docker-user docker-user\nUSER docker-user\n# Please add your HEALTHCHECK here!!!\n","originalDockerfile":"FROM debian:stretch-slim\nLABEL maintainer=\"Thomas VIAL\"\nENV DEBIAN_FRONTEND=\"noninteractive\"\nENV VIRUSMAILS_DELETE_DELAY=\"7\"\nENV ONE_DIR=\"0\"\nENV ENABLE_POSTGREY=\"0\"\nENV FETCHMAIL_POLL=\"300\"\nENV POSTGREY_DELAY=\"300\"\nENV POSTGREY_MAX_AGE=\"35\"\nENV POSTGREY_AUTO_WHITELIST_CLIENTS=\"5\"\nENV POSTGREY_TEXT=\"Delayed by postgrey\"\nENV SASLAUTHD_MECHANISMS=\"pam\"\nENV SASLAUTHD_MECH_OPTIONS=\"\"\n#  Packages\nRUN apt-get update -q --fix-missing \\\n && apt-get -y upgrade \\\n && apt-get install postfix -y \\\n && apt-get install --no-install-recommends amavisd-new arj binutils bzip2 ca-certificates cabextract clamav clamav-daemon cpio curl ed fail2ban fetchmail file gamin gzip gnupg iproute2 iptables locales liblz4-tool libmail-spf-perl libnet-dns-perl libsasl2-modules lrzip lzop netcat-openbsd nomarch opendkim opendkim-tools opendmarc pax pflogsumm p7zip-full postfix-ldap postfix-pcre postfix-policyd-spf-python postsrsd pyzor razor ripole rpm2cpio rsyslog sasl2-bin spamassassin supervisor postgrey unrar-free unzip xz-utils zoo -y \\\n && curl https://packages.elasticsearch.org/GPG-KEY-elasticsearch | apt-key add - \\\n && echo \"deb http://packages.elastic.co/beats/apt stable main\" | tee -a /etc/apt/sources.list.d/beats.list \\\n && echo \"deb http://ftp.debian.org/debian stretch-backports main\" | tee -a /etc/apt/sources.list.d/stretch-bp.list \\\n && apt-get update -q --fix-missing \\\n && apt-get -y upgrade filebeat \\\n && apt-get -t stretch-backports -y install --no-install-recommends dovecot-core dovecot-imapd dovecot-ldap dovecot-lmtpd dovecot-managesieved dovecot-pop3d dovecot-sieve \\\n && apt-get autoclean \\\n && rm -rf /var/lib/apt/lists/* \\\n && rm -rf /usr/share/locale/* \\\n && rm -rf /usr/share/man/* \\\n && rm -rf /usr/share/doc/* \\\n && touch /var/log/auth.log \\\n && update-locale \\\n && rm -f /etc/cron.weekly/fstrim \\\n && rm -f /etc/postsrsd.secret\nRUN echo \"0 0,6,12,18 * * * /usr/bin/freshclam --quiet\" > /etc/cron.d/clamav-freshclam \\\n && chmod 644 /etc/clamav/freshclam.conf \\\n && freshclam \\\n && sed -i 's/Foreground false/Foreground true/g' /etc/clamav/clamd.conf \\\n && sed -i 's/AllowSupplementaryGroups false/AllowSupplementaryGroups true/g' /etc/clamav/clamd.conf \\\n && mkdir /var/run/clamav \\\n && chown -R clamav:root /var/run/clamav\n#  Configures Dovecot\nCOPY target/dovecot/auth-passwdfile.inc target/dovecot/??-*.conf /etc/dovecot/conf.d/\nRUN sed -i -e 's/include_try \\/usr\\/share\\/dovecot\\/protocols\\.d/include_try \\/etc\\/dovecot\\/protocols\\.d/g' /etc/dovecot/dovecot.conf \\\n && sed -i -e 's/#mail_plugins = \\$mail_plugins/mail_plugins = \\$mail_plugins sieve/g' /etc/dovecot/conf.d/15-lda.conf \\\n && sed -i -e 's/^.*lda_mailbox_autocreate.*/lda_mailbox_autocreate = yes/g' /etc/dovecot/conf.d/15-lda.conf \\\n && sed -i -e 's/^.*lda_mailbox_autosubscribe.*/lda_mailbox_autosubscribe = yes/g' /etc/dovecot/conf.d/15-lda.conf \\\n && sed -i -e 's/^.*postmaster_address.*/postmaster_address = '${POSTMASTER_ADDRESS:=\"postmaster@domain.com\"}'/g' /etc/dovecot/conf.d/15-lda.conf \\\n && sed -i 's/#imap_idle_notify_interval = 2 mins/imap_idle_notify_interval = 29 mins/' /etc/dovecot/conf.d/20-imap.conf \\\n && mkdir /etc/dovecot/ssl \\\n && chmod 755 /etc/dovecot/ssl \\\n && cd /usr/share/dovecot \\\n && ./mkcert.sh \\\n && mkdir -p /usr/lib/dovecot/sieve-pipe /usr/lib/dovecot/sieve-filter /usr/lib/dovecot/sieve-global \\\n && chmod 755 -R /usr/lib/dovecot/sieve-pipe /usr/lib/dovecot/sieve-filter /usr/lib/dovecot/sieve-global\n#  Configures LDAP\nCOPY target/dovecot/dovecot-ldap.conf.ext /etc/dovecot\nCOPY target/postfix/ldap-users.cf target/postfix/ldap-groups.cf target/postfix/ldap-aliases.cf target/postfix/ldap-domains.cf /etc/postfix/\n#  Enables Spamassassin CRON updates and update hook for supervisor\nRUN sed -i -r 's/^(CRON)=0/\\1=1/g' /etc/default/spamassassin \\\n && sed -i -r 's/^\\$INIT restart/supervisorctl restart amavis/g' /etc/spamassassin/sa-update-hooks.d/amavisd-new\n#  Enables Postgrey\nCOPY target/postgrey/postgrey /etc/default/postgrey\nCOPY target/postgrey/postgrey.init /etc/init.d/postgrey\nRUN chmod 755 /etc/init.d/postgrey \\\n && mkdir /var/run/postgrey \\\n && chown postgrey:postgrey /var/run/postgrey\n#  Copy PostSRSd Config\nCOPY target/postsrsd/postsrsd /etc/default/postsrsd\n#  Enables Amavis\nCOPY target/amavis/conf.d/* /etc/amavis/conf.d/\nRUN sed -i -r 's/#(@| \\\\%)bypass/\\1bypass/g' /etc/amavis/conf.d/15-content_filter_mode \\\n && adduser clamav amavis \\\n && adduser amavis clamav \\\n && adduser --system syslog \\\n && useradd -u 5000 -d /home/docker -s /bin/bash -p $( echo docker | openssl passwd -1 -stdin ;) docker \\\n && (echo \"0 4 * * * /usr/local/bin/virus-wiper\" ;crontab -l ) | crontab -\n#  Configure Fail2ban\nCOPY target/fail2ban/jail.conf /etc/fail2ban/jail.conf\nCOPY target/fail2ban/filter.d/dovecot.conf /etc/fail2ban/filter.d/dovecot.conf\nRUN echo \"ignoreregex =\" >> /etc/fail2ban/filter.d/postfix-sasl.conf \\\n && mkdir /var/run/fail2ban\n#  Enables Pyzor and Razor\nUSER amavis\nRUN razor-admin -create \\\n && razor-admin -register\nUSER root\n#  Configure DKIM (opendkim)\n#  DKIM config files\nCOPY target/opendkim/opendkim.conf /etc/opendkim.conf\nCOPY target/opendkim/default-opendkim /etc/default/opendkim\n#  Configure DMARC (opendmarc)\nCOPY target/opendmarc/opendmarc.conf /etc/opendmarc.conf\nCOPY target/opendmarc/default-opendmarc /etc/default/opendmarc\nCOPY target/opendmarc/ignore.hosts /etc/opendmarc/ignore.hosts\n#  Configure fetchmail\nCOPY target/fetchmail/fetchmailrc /etc/fetchmailrc_general\nRUN sed -i 's/START_DAEMON=no/START_DAEMON=yes/g' /etc/default/fetchmail\nRUN mkdir /var/run/fetchmail \\\n && chown fetchmail /var/run/fetchmail\n#  Configures Postfix\nCOPY target/postfix/main.cf target/postfix/master.cf /etc/postfix/\nCOPY target/postfix/header_checks.pcre target/postfix/sender_header_filter.pcre target/postfix/sender_login_maps.pcre /etc/postfix/maps/\nRUN echo \"\" > /etc/aliases \\\n && openssl dhparam -out /etc/postfix/dhparams.pem 2048 \\\n && echo \"@weekly FILE=`mktemp ` ; openssl dhparam -out $FILE 2048 > /dev/null 2>&1 \\\n && mv -f $FILE /etc/postfix/dhparams.pem\" > /etc/cron.d/dh2048\n#  Configuring Logs\nRUN sed -i -r \"/^#?compress/c\\compress\\ncopytruncate\" /etc/logrotate.conf \\\n && mkdir -p /var/log/mail \\\n && chown syslog:root /var/log/mail \\\n && touch /var/log/mail/clamav.log \\\n && chown -R clamav:root /var/log/mail/clamav.log \\\n && touch /var/log/mail/freshclam.log \\\n && chown -R clamav:root /var/log/mail/freshclam.log \\\n && sed -i -r 's|/var/log/mail|/var/log/mail/mail|g' /etc/rsyslog.conf \\\n && sed -i -r 's|;auth,authpriv.none|;mail.none;mail.error;auth,authpriv.none|g' /etc/rsyslog.conf \\\n && sed -i -r 's|LogFile /var/log/clamav/|LogFile /var/log/mail/|g' /etc/clamav/clamd.conf \\\n && sed -i -r 's|UpdateLogFile /var/log/clamav/|UpdateLogFile /var/log/mail/|g' /etc/clamav/freshclam.conf \\\n && sed -i -r 's|/var/log/clamav|/var/log/mail|g' /etc/logrotate.d/clamav-daemon \\\n && sed -i -r 's|/var/log/clamav|/var/log/mail|g' /etc/logrotate.d/clamav-freshclam \\\n && sed -i -r 's|/var/log/mail|/var/log/mail/mail|g' /etc/logrotate.d/rsyslog \\\n && sed -i -r '/\\/var\\/log\\/mail\\/mail.log/d' /etc/logrotate.d/rsyslog \\\n && sed -i -e 's/\\(printerror \"could not determine current runlevel\"\\)/#\\1/' /usr/sbin/invoke-rc.d \\\n && sed -i -e 's/^\\(POLICYHELPER=\\).*/\\1/' /usr/sbin/invoke-rc.d \\\n && sed -i -e 's/invoke-rc.d rsyslog rotate > \\/dev\\/null/invoke-rc.d rsyslog --quiet rotate > \\/dev\\/null/g' /etc/logrotate.d/rsyslog\n#  Get LetsEncrypt signed certificate\nRUN curl -s https://letsencrypt.org/certs/lets-encrypt-x3-cross-signed.pem > /etc/ssl/certs/lets-encrypt-x3-cross-signed.pem\nCOPY ./target/bin /usr/local/bin\n#  Start-mailserver script\nCOPY ./target/check-for-changes.sh ./target/start-mailserver.sh ./target/fail2ban-wrapper.sh ./target/postfix-wrapper.sh ./target/postsrsd-wrapper.sh ./target/docker-configomat/configomat.sh /usr/local/bin/\nRUN chmod +x /usr/local/bin/*\n#  Configure supervisor\nCOPY target/supervisor/supervisord.conf /etc/supervisor/supervisord.conf\nCOPY target/supervisor/conf.d/* /etc/supervisor/conf.d/\nEXPOSE 25/tcp 587/tcp 143/tcp 465/tcp 993/tcp 110/tcp 995/tcp 4190/tcp\nCMD [\"supervisord\", \"-c\", \"/etc/supervisor/supervisord.conf\"]\nADD target/filebeat.yml.tmpl /etc/filebeat/filebeat.yml.tmpl\n","injectedSmells":[],"originalDockerfileHash":"99d6d291fb5e2a74da75a19899a8db6b","successfullyInjectedSmells":[],"originalDockerfileUglified":"FROM debian:stretch-slim\nLABEL maintainer=\"Thomas VIAL\"\nENV DEBIAN_FRONTEND=\"noninteractive\"\nENV VIRUSMAILS_DELETE_DELAY=\"7\"\nENV ONE_DIR=\"0\"\nENV ENABLE_POSTGREY=\"0\"\nENV FETCHMAIL_POLL=\"300\"\nENV POSTGREY_DELAY=\"300\"\nENV POSTGREY_MAX_AGE=\"35\"\nENV POSTGREY_AUTO_WHITELIST_CLIENTS=\"5\"\nENV POSTGREY_TEXT=\"Delayed by postgrey\"\nENV SASLAUTHD_MECHANISMS=\"pam\"\nENV SASLAUTHD_MECH_OPTIONS=\"\"\n#   Packages\nRUN apt-get update -q --fix-missing \\\n && apt-get -y upgrade \\\n && apt-get install postfix -y \\\n && apt-get install --no-install-recommends amavisd-new arj binutils bzip2 ca-certificates cabextract clamav clamav-daemon cpio curl ed fail2ban fetchmail file gamin gzip gnupg iproute2 iptables locales liblz4-tool libmail-spf-perl libnet-dns-perl libsasl2-modules lrzip lzop netcat-openbsd nomarch opendkim opendkim-tools opendmarc pax pflogsumm p7zip-full postfix-ldap postfix-pcre postfix-policyd-spf-python postsrsd pyzor razor ripole rpm2cpio rsyslog sasl2-bin spamassassin supervisor postgrey unrar-free unzip xz-utils zoo -y \\\n && curl https://packages.elasticsearch.org/GPG-KEY-elasticsearch | apt-key add - \\\n && echo \"deb http://packages.elastic.co/beats/apt stable main\" | tee -a /etc/apt/sources.list.d/beats.list \\\n && echo \"deb http://ftp.debian.org/debian stretch-backports main\" | tee -a /etc/apt/sources.list.d/stretch-bp.list \\\n && apt-get update -q --fix-missing \\\n && apt-get -y upgrade filebeat \\\n && apt-get -t stretch-backports -y install --no-install-recommends dovecot-core dovecot-imapd dovecot-ldap dovecot-lmtpd dovecot-managesieved dovecot-pop3d dovecot-sieve \\\n && apt-get autoclean \\\n && rm -rf /var/lib/apt/lists/* \\\n && rm -rf /usr/share/locale/* \\\n && rm -rf /usr/share/man/* \\\n && rm -rf /usr/share/doc/* \\\n && touch /var/log/auth.log \\\n && update-locale \\\n && rm -f /etc/cron.weekly/fstrim \\\n && rm -f /etc/postsrsd.secret\nRUN echo \"0 0,6,12,18 * * * /usr/bin/freshclam --quiet\" > /etc/cron.d/clamav-freshclam \\\n && chmod 644 /etc/clamav/freshclam.conf \\\n && freshclam \\\n && sed -i 's/Foreground false/Foreground true/g' /etc/clamav/clamd.conf \\\n && sed -i 's/AllowSupplementaryGroups false/AllowSupplementaryGroups true/g' /etc/clamav/clamd.conf \\\n && mkdir /var/run/clamav \\\n && chown -R clamav:root /var/run/clamav\n#   Configures Dovecot\nCOPY target/dovecot/auth-passwdfile.inc target/dovecot/??-*.conf /etc/dovecot/conf.d/\nRUN sed -i -e 's/include_try \\/usr\\/share\\/dovecot\\/protocols\\.d/include_try \\/etc\\/dovecot\\/protocols\\.d/g' /etc/dovecot/dovecot.conf \\\n && sed -i -e 's/#mail_plugins = \\$mail_plugins/mail_plugins = \\$mail_plugins sieve/g' /etc/dovecot/conf.d/15-lda.conf \\\n && sed -i -e 's/^.*lda_mailbox_autocreate.*/lda_mailbox_autocreate = yes/g' /etc/dovecot/conf.d/15-lda.conf \\\n && sed -i -e 's/^.*lda_mailbox_autosubscribe.*/lda_mailbox_autosubscribe = yes/g' /etc/dovecot/conf.d/15-lda.conf \\\n && sed -i -e 's/^.*postmaster_address.*/postmaster_address = '${POSTMASTER_ADDRESS:=\"postmaster@domain.com\"}'/g' /etc/dovecot/conf.d/15-lda.conf \\\n && sed -i 's/#imap_idle_notify_interval = 2 mins/imap_idle_notify_interval = 29 mins/' /etc/dovecot/conf.d/20-imap.conf \\\n && mkdir /etc/dovecot/ssl \\\n && chmod 755 /etc/dovecot/ssl \\\n && cd /usr/share/dovecot \\\n && ./mkcert.sh \\\n && mkdir -p /usr/lib/dovecot/sieve-pipe /usr/lib/dovecot/sieve-filter /usr/lib/dovecot/sieve-global \\\n && chmod 755 -R /usr/lib/dovecot/sieve-pipe /usr/lib/dovecot/sieve-filter /usr/lib/dovecot/sieve-global\n#   Configures LDAP\nCOPY target/dovecot/dovecot-ldap.conf.ext /etc/dovecot\nCOPY target/postfix/ldap-users.cf target/postfix/ldap-groups.cf target/postfix/ldap-aliases.cf target/postfix/ldap-domains.cf /etc/postfix/\n#   Enables Spamassassin CRON updates and update hook for supervisor\nRUN sed -i -r 's/^(CRON)=0/\\1=1/g' /etc/default/spamassassin \\\n && sed -i -r 's/^\\$INIT restart/supervisorctl restart amavis/g' /etc/spamassassin/sa-update-hooks.d/amavisd-new\n#   Enables Postgrey\nCOPY target/postgrey/postgrey /etc/default/postgrey\nCOPY target/postgrey/postgrey.init /etc/init.d/postgrey\nRUN chmod 755 /etc/init.d/postgrey \\\n && mkdir /var/run/postgrey \\\n && chown postgrey:postgrey /var/run/postgrey\n#   Copy PostSRSd Config\nCOPY target/postsrsd/postsrsd /etc/default/postsrsd\n#   Enables Amavis\nCOPY target/amavis/conf.d/* /etc/amavis/conf.d/\nRUN sed -i -r 's/#(@| \\\\%)bypass/\\1bypass/g' /etc/amavis/conf.d/15-content_filter_mode \\\n && adduser clamav amavis \\\n && adduser amavis clamav \\\n && adduser --system syslog \\\n && useradd -u 5000 -d /home/docker -s /bin/bash -p $( echo docker | openssl passwd -1 -stdin ;) docker \\\n && (echo \"0 4 * * * /usr/local/bin/virus-wiper\" ;crontab -l ) | crontab -\n#   Configure Fail2ban\nCOPY target/fail2ban/jail.conf /etc/fail2ban/jail.conf\nCOPY target/fail2ban/filter.d/dovecot.conf /etc/fail2ban/filter.d/dovecot.conf\nRUN echo \"ignoreregex =\" >> /etc/fail2ban/filter.d/postfix-sasl.conf \\\n && mkdir /var/run/fail2ban\n#   Enables Pyzor and Razor\nUSER amavis\nRUN razor-admin -create \\\n && razor-admin -register\nUSER root\n#   Configure DKIM (opendkim)\n#   DKIM config files\nCOPY target/opendkim/opendkim.conf /etc/opendkim.conf\nCOPY target/opendkim/default-opendkim /etc/default/opendkim\n#   Configure DMARC (opendmarc)\nCOPY target/opendmarc/opendmarc.conf /etc/opendmarc.conf\nCOPY target/opendmarc/default-opendmarc /etc/default/opendmarc\nCOPY target/opendmarc/ignore.hosts /etc/opendmarc/ignore.hosts\n#   Configure fetchmail\nCOPY target/fetchmail/fetchmailrc /etc/fetchmailrc_general\nRUN sed -i 's/START_DAEMON=no/START_DAEMON=yes/g' /etc/default/fetchmail\nRUN mkdir /var/run/fetchmail \\\n && chown fetchmail /var/run/fetchmail\n#   Configures Postfix\nCOPY target/postfix/main.cf target/postfix/master.cf /etc/postfix/\nCOPY target/postfix/header_checks.pcre target/postfix/sender_header_filter.pcre target/postfix/sender_login_maps.pcre /etc/postfix/maps/\nRUN echo \"\" > /etc/aliases \\\n && openssl dhparam -out /etc/postfix/dhparams.pem 2048 \\\n && echo \"@weekly FILE=`mktemp ` ; openssl dhparam -out $FILE 2048 > /dev/null 2>&1 \\\n && mv -f $FILE /etc/postfix/dhparams.pem\" > /etc/cron.d/dh2048\n#   Configuring Logs\nRUN sed -i -r \"/^#?compress/c\\compress\\ncopytruncate\" /etc/logrotate.conf \\\n && mkdir -p /var/log/mail \\\n && chown syslog:root /var/log/mail \\\n && touch /var/log/mail/clamav.log \\\n && chown -R clamav:root /var/log/mail/clamav.log \\\n && touch /var/log/mail/freshclam.log \\\n && chown -R clamav:root /var/log/mail/freshclam.log \\\n && sed -i -r 's|/var/log/mail|/var/log/mail/mail|g' /etc/rsyslog.conf \\\n && sed -i -r 's|;auth,authpriv.none|;mail.none;mail.error;auth,authpriv.none|g' /etc/rsyslog.conf \\\n && sed -i -r 's|LogFile /var/log/clamav/|LogFile /var/log/mail/|g' /etc/clamav/clamd.conf \\\n && sed -i -r 's|UpdateLogFile /var/log/clamav/|UpdateLogFile /var/log/mail/|g' /etc/clamav/freshclam.conf \\\n && sed -i -r 's|/var/log/clamav|/var/log/mail|g' /etc/logrotate.d/clamav-daemon \\\n && sed -i -r 's|/var/log/clamav|/var/log/mail|g' /etc/logrotate.d/clamav-freshclam \\\n && sed -i -r 's|/var/log/mail|/var/log/mail/mail|g' /etc/logrotate.d/rsyslog \\\n && sed -i -r '/\\/var\\/log\\/mail\\/mail.log/d' /etc/logrotate.d/rsyslog \\\n && sed -i -e 's/\\(printerror \"could not determine current runlevel\"\\)/#\\1/' /usr/sbin/invoke-rc.d \\\n && sed -i -e 's/^\\(POLICYHELPER=\\).*/\\1/' /usr/sbin/invoke-rc.d \\\n && sed -i -e 's/invoke-rc.d rsyslog rotate > \\/dev\\/null/invoke-rc.d rsyslog --quiet rotate > \\/dev\\/null/g' /etc/logrotate.d/rsyslog\n#   Get LetsEncrypt signed certificate\nRUN curl -s https://letsencrypt.org/certs/lets-encrypt-x3-cross-signed.pem > /etc/ssl/certs/lets-encrypt-x3-cross-signed.pem\nCOPY ./target/bin /usr/local/bin\n#   Start-mailserver script\nCOPY ./target/check-for-changes.sh ./target/start-mailserver.sh ./target/fail2ban-wrapper.sh ./target/postfix-wrapper.sh ./target/postsrsd-wrapper.sh ./target/docker-configomat/configomat.sh /usr/local/bin/\nRUN chmod +x /usr/local/bin/*\n#   Configure supervisor\nCOPY target/supervisor/supervisord.conf /etc/supervisor/supervisord.conf\nCOPY target/supervisor/conf.d/* /etc/supervisor/conf.d/\nEXPOSE 25/tcp 587/tcp 143/tcp 465/tcp 993/tcp 110/tcp 995/tcp 4190/tcp\nCMD [\"supervisord\", \"-c\", \"/etc/supervisor/supervisord.conf\"]\nADD target/filebeat.yml.tmpl /etc/filebeat/filebeat.yml.tmpl\n","originalDockerfileUglifiedHash":"fefd04f0bce0f98ad2ab7bd3d2c366d3","fileName":"/ICSME-replicationpackage/dataset/smelly_dockerfiles_bianncle/9a99848146acf46f1228799af5d544368e876ca7.dockerfile"}