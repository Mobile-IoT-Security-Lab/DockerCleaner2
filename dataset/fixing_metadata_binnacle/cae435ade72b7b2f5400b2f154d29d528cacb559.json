{"seed":1984738973,"processedDockerfileHash":"3e7fa244983ef82bb0ff2e1cefb46997","fixedSmells":["use-no-install-recommends","do-not-use-apt-get-update-alone","pin-package-manager-versions-apt-get","pin-package-manager-versions-pip","pin-package-manager-versions-npm","pin-package-manager-versions-gem","pin-package-manager-versions-apk","use-copy-instead-of-add","use-wget-instead-of-add","do-not-have-secrets","have-a-healthcheck","have-a-user"],"successfullyFixedSmells":["use-no-install-recommends","do-not-use-apt-get-update-alone","pin-package-manager-versions-pip","pin-package-manager-versions-apk","use-copy-instead-of-add","have-a-healthcheck","have-a-user"],"processedDockerfile":"FROM csp-alpine35glibc:1.0 AS builder_2.4.107\nRUN apk add git --no-cache\nWORKDIR /var/www\n#  RUN chown www-data:www-data /var/www\n#  USER www-data\nRUN git clone https://github.com/MISP/MISP.git\nWORKDIR /var/www/MISP\n#  RUN git checkout tags/$(git describe --tags `git rev-list --tags --max-count=1000`)\nRUN git checkout tags/$( git describe --tags v2.4.107 ;)\nRUN git config core.filemode false\nWORKDIR /var/www/MISP/app/files/scripts\nRUN git clone https://github.com/CybOXProject/python-cybox.git\nRUN git clone https://github.com/STIXProject/python-stix.git\nWORKDIR /var/www/MISP/app/files/scripts/python-cybox\nRUN git checkout v2.1.0.12\n#  USER www-data\nWORKDIR /var/www/MISP/app/files/scripts/python-stix\nRUN git checkout v1.1.1.4\n#  USER www-data\nWORKDIR /var/www/MISP\nRUN git submodule init\nRUN git submodule update\n#   Install MISP Modules\nWORKDIR /opt\nRUN git clone https://github.com/MISP/misp-modules.git\nFROM ubuntu:16.04\nMAINTAINER Christos Panagiotou\n#   Install core components\nENV DEBIAN_FRONTEND=\"noninteractive\"\nRUN : \\\n && apt-get dist-upgrade -y \\\n && apt-get autoremove -y \\\n && apt-get clean\nRUN (apt-get update ;apt-get install --no-install-recommends software-properties-common -y )\nRUN (apt-get update ;apt-get install --no-install-recommends postfix -y )\nRUN (apt-get update ;apt-get install --no-install-recommends mysql-client curl gcc gnupg-agent make python openssl redis-server sudo vim zip locales -y )\nRUN locale-gen en_US.UTF-8\nENV LANG=\"en_US.UTF-8\"\nRUN add-apt-repository -y ppa:ondrej/php \\\n && :\n#   Apache\nRUN (apt-get update ;apt-get install --no-install-recommends apache2 apache2-doc apache2-utils -y )\nRUN a2dismod status\nRUN a2dissite 000-default\n#   PHP 7.2\nRUN (apt-get update ;apt-get install --no-install-recommends libapache2-mod-php php7.2 php7.2-cli php-crypt-gpg php7.2-dev php7.2-json php7.2-mysql php7.2-opcache php7.2-readline php7.2-redis php7.2-xml git -y )\n#   Fix php.ini with recommended settings\nRUN sed -i \"s/max_execution_time = 30/max_execution_time = 300/\" /etc/php/7.2/apache2/php.ini\nRUN sed -i \"s/memory_limit = 128M/memory_limit = 512M/\" /etc/php/7.2/apache2/php.ini\nRUN sed -i \"s/upload_max_filesize = 2M/upload_max_filesize = 50M/\" /etc/php/7.2/apache2/php.ini\nRUN sed -i \"s/post_max_size = 8M/post_max_size = 50M/\" /etc/php/7.2/apache2/php.ini\nRUN (apt-get update ;apt-get install --no-install-recommends python-dev python-pip libxml2-dev libxslt1-dev zlib1g-dev python-setuptools -y )\nRUN (apt-get update ;apt-get install --no-install-recommends cron logrotate supervisor syslog-ng-core -y )\nRUN apt-get clean\nWORKDIR /var/www\nUSER www-data\nCOPY --from=builder_2.4.107 /var/www/ .\nWORKDIR /var/www/MISP/app/files/scripts/python-cybox\nUSER root\nRUN python setup.py install\nUSER www-data\nWORKDIR /var/www/MISP/app/files/scripts/python-stix\nUSER root\nRUN python setup.py install\nRUN chown -R www-data:www-data /var/www\nUSER www-data\nWORKDIR /var/www/MISP/app\nRUN php composer.phar config vendor-dir Vendor\nRUN php composer.phar install\nUSER root\nRUN phpenmod redis\nUSER www-data\nRUN cp -fa /var/www/MISP/INSTALL/setup/config.php /var/www/MISP/app/Plugin/CakeResque/Config/config.php\n#   Fix permissions\nUSER root\nRUN chown -R www-data:www-data /var/www/MISP\nRUN chmod -R 750 /var/www/MISP\nRUN chmod -R g+ws /var/www/MISP/app/tmp\nRUN chmod -R g+ws /var/www/MISP/app/files\nRUN chmod -R g+ws /var/www/MISP/app/files/scripts/tmp\nRUN cp /var/www/MISP/INSTALL/misp.logrotate /etc/logrotate.d/misp\n#   Preconfigure setting for packages\nRUN echo \"postfix postfix/main_mailer_type string Local only\" | debconf-set-selections\nRUN echo \"postfix postfix/mailname string localhost.localdomain\" | debconf-set-selections\n#   Redis Setup\nRUN sed -i 's/^\\(daemonize\\s*\\)yes\\s*$/\\1no/g' /etc/redis/redis.conf\n#   Install PEAR packages\nRUN pear install Crypt_GPG >> /tmp/install.log\nRUN pear install Net_GeoIP\n#   Apache Setup\nRUN cp /var/www/MISP/INSTALL/apache.misp.ubuntu /etc/apache2/sites-available/misp.conf\nRUN sed -i -E 's/80/800/' /etc/apache2/sites-available/misp.conf\nRUN sed -i -E 's/80/800/' /etc/apache2/ports.conf\nRUN a2dissite 000-default\nRUN a2ensite misp\nRUN a2enmod rewrite\nRUN a2enmod headers\n#   MISP base configuration\nRUN sudo -u www-data cp -a /var/www/MISP/app/Config/bootstrap.default.php /var/www/MISP/app/Config/bootstrap.php\nRUN sudo -u www-data cp -a /var/www/MISP/app/Config/database.default.php /var/www/MISP/app/Config/database.php\nRUN sudo -u www-data cp -a /var/www/MISP/app/Config/core.default.php /var/www/MISP/app/Config/core.php\nRUN sudo -u www-data cp -a /var/www/MISP/app/Config/config.default.php /var/www/MISP/app/Config/config.php\nRUN chown -R www-data:www-data /var/www/MISP/app/Config\nRUN chmod -R 750 /var/www/MISP/app/Config\n#   Replace the default salt\nRUN sed -i -E \"s/'salt'\\s=>\\s'(\\S+)'/'salt' => '`openssl rand -base64 32 | tr \"/\" \"-\" `'/\" /var/www/MISP/app/Config/config.php\n#   Enable workers at boot time\nRUN chmod a+x /var/www/MISP/app/Console/worker/start.sh\nRUN echo \"sudo -u www-data bash /var/www/MISP/app/Console/worker/start.sh\" >> /etc/rc.local\n#   Install MISP Modules\nWORKDIR /opt\nRUN :\nRUN (apt-get update ;apt-get install --no-install-recommends python3 python3-pip libjpeg-dev -y )\nCOPY --from=builder_2.4.107 /opt/ .\nCOPY misp-modules /opt/misp-modules\nWORKDIR /opt/misp-modules\nRUN pip3 install --upgrade pip\nRUN cat REQUIREMENTS | sed 's/aiohttp==3.4.4/aiohttp/g' > REQUIREMENTS\nRUN pip3 install --upgrade --ignore-installed urllib3\nRUN pip3 install --upgrade --ignore-installed requests\nRUN sed -i 's/aiohttp.*/aiohttp/g' REQUIREMENTS\nRUN sed -i 's/functools.*//g' REQUIREMENTS\nRUN sed -i 's/async-timeout.*/async-timeout/g' REQUIREMENTS\nRUN sed -i 's/url-normalize.*/url-normalize/g' REQUIREMENTS\nRUN sed -i 's/^\\(yarl\\)\\=.*/\\1/g' REQUIREMENTS\nRUN sed -i 's/^\\(sigmatools\\)\\=.*/\\1/' REQUIREMENTS\nRUN pip3 install -I -r REQUIREMENTS\nRUN pip3 install -I .\nRUN pip install zmq==0.0.0 redis==4.5.4\nRUN pip3 install zmq redis\nRUN echo \"sudo -u www-data misp-modules -s &\" >> /etc/rc.local\n#   Supervisord Setup\nRUN echo '[supervisord]' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'nodaemon = true' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '[program:postfix]' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'process_name = master' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'directory = /etc/postfix' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'command = /usr/sbin/postfix -c /etc/postfix start' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'startsecs = 0' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'autorestart = false' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '[program:redis-server]' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'command=redis-server /etc/redis/redis.conf' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '[program:apache2]' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'command=/bin/bash -c \"source /etc/apache2/envvars \\\n && exec /usr/sbin/apache2 -D FOREGROUND\"' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '[program:resque]' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'command=/bin/bash /var/www/MISP/app/Console/worker/start.sh' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'user = www-data' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'startsecs = 0' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'autorestart = false' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '[program:misp-modules]' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'command=/bin/bash -c \"cd /opt/misp-modules/bin \\\n && /usr/bin/python3 misp-modules.py\"' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'user = root' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'startsecs = 0' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'autorestart = false' >> /etc/supervisor/conf.d/supervisord.conf\n#   Modify syslog configuration\nRUN sed -i -E 's/^(\\s*)system\\(\\);/\\1unix-stream(\"\\/dev\\/log\");/' /etc/syslog-ng/syslog-ng.conf\n#   Add run script\nCOPY run.sh /run.sh\nCOPY csp_configuration /csp_configuration\nRUN chmod 0755 /run.sh\n#   Trigger to perform first boot operations\nRUN touch /.firstboot.tmp\nRUN touch /var/www/MISP/app/tmp/logs/error.log\nRUN touch /var/www/MISP/app/tmp/logs/debug.log\nRUN chmod -R 777 /var/www/MISP/app/tmp/logs/\nRUN chown -R www-data:www-data /var/www/MISP/app/tmp/logs/\nVOLUME [\"/var/www/MISP/app/tmp/logs\"]\n#   Make a backup of /var/www/MISP to restore it to the local moint point at first boot\nWORKDIR /var/www/MISP\n#   Add misp-objects for CSP support\nCOPY csp-misp-objects/ app/files/misp-objects/objects/\nRUN chown -R www-data:www-data /var/www/MISP/app/files/\n#   Final archive\nRUN tar czpf /root/MISP.tgz .\n#  COPY AppController.php /var/www/MISP/app/Controller/AppController.php\n#  VOLUME /var/www/MISP\nEXPOSE 80/tcp\nENTRYPOINT [\"/run.sh\"]\nRUN groupadd --system docker-user ; useradd --system --gid docker-user docker-user\nUSER docker-user\n# Please add your HEALTHCHECK here!!!\n","originalDockerfile":"FROM csp-alpine35glibc:1.0 AS builder_2.4.107\nRUN apk add --no-cache git\nWORKDIR /var/www\n# RUN chown www-data:www-data /var/www\n# USER www-data\nRUN git clone https://github.com/MISP/MISP.git\nWORKDIR /var/www/MISP\n# RUN git checkout tags/$(git describe --tags `git rev-list --tags --max-count=1000`)\nRUN git checkout tags/$( git describe --tags v2.4.107 ;)\nRUN git config core.filemode false\nWORKDIR /var/www/MISP/app/files/scripts\nRUN git clone https://github.com/CybOXProject/python-cybox.git\nRUN git clone https://github.com/STIXProject/python-stix.git\nWORKDIR /var/www/MISP/app/files/scripts/python-cybox\nRUN git checkout v2.1.0.12\n# USER www-data\nWORKDIR /var/www/MISP/app/files/scripts/python-stix\nRUN git checkout v1.1.1.4\n# USER www-data\nWORKDIR /var/www/MISP\nRUN git submodule init\nRUN git submodule update\n#  Install MISP Modules\nWORKDIR /opt\nRUN git clone https://github.com/MISP/misp-modules.git\nFROM ubuntu:16.04\nMAINTAINER Christos Panagiotou\n#  Install core components\nENV DEBIAN_FRONTEND=\"noninteractive\"\nRUN apt-get update \\\n && apt-get dist-upgrade -y \\\n && apt-get autoremove -y \\\n && apt-get clean\nRUN apt-get install software-properties-common -y\nRUN apt-get install postfix -y\nRUN apt-get install mysql-client curl gcc gnupg-agent make python openssl redis-server sudo vim zip locales -y\nRUN locale-gen en_US.UTF-8\nENV LANG=\"en_US.UTF-8\"\nRUN add-apt-repository -y ppa:ondrej/php \\\n && apt-get update\n#  Apache\nRUN apt-get install apache2 apache2-doc apache2-utils -y\nRUN a2dismod status\nRUN a2dissite 000-default\n#  PHP 7.2\nRUN apt-get install libapache2-mod-php php7.2 php7.2-cli php-crypt-gpg php7.2-dev php7.2-json php7.2-mysql php7.2-opcache php7.2-readline php7.2-redis php7.2-xml git -y\n#  Fix php.ini with recommended settings\nRUN sed -i \"s/max_execution_time = 30/max_execution_time = 300/\" /etc/php/7.2/apache2/php.ini\nRUN sed -i \"s/memory_limit = 128M/memory_limit = 512M/\" /etc/php/7.2/apache2/php.ini\nRUN sed -i \"s/upload_max_filesize = 2M/upload_max_filesize = 50M/\" /etc/php/7.2/apache2/php.ini\nRUN sed -i \"s/post_max_size = 8M/post_max_size = 50M/\" /etc/php/7.2/apache2/php.ini\nRUN apt-get install python-dev python-pip libxml2-dev libxslt1-dev zlib1g-dev python-setuptools -y\nRUN apt-get install cron logrotate supervisor syslog-ng-core -y\nRUN apt-get clean\nWORKDIR /var/www\nUSER www-data\nCOPY --from=builder_2.4.107 /var/www/ .\nWORKDIR /var/www/MISP/app/files/scripts/python-cybox\nUSER root\nRUN python setup.py install\nUSER www-data\nWORKDIR /var/www/MISP/app/files/scripts/python-stix\nUSER root\nRUN python setup.py install\nRUN chown -R www-data:www-data /var/www\nUSER www-data\nWORKDIR /var/www/MISP/app\nRUN php composer.phar config vendor-dir Vendor\nRUN php composer.phar install\nUSER root\nRUN phpenmod redis\nUSER www-data\nRUN cp -fa /var/www/MISP/INSTALL/setup/config.php /var/www/MISP/app/Plugin/CakeResque/Config/config.php\n#  Fix permissions\nUSER root\nRUN chown -R www-data:www-data /var/www/MISP\nRUN chmod -R 750 /var/www/MISP\nRUN chmod -R g+ws /var/www/MISP/app/tmp\nRUN chmod -R g+ws /var/www/MISP/app/files\nRUN chmod -R g+ws /var/www/MISP/app/files/scripts/tmp\nRUN cp /var/www/MISP/INSTALL/misp.logrotate /etc/logrotate.d/misp\n#  Preconfigure setting for packages\nRUN echo \"postfix postfix/main_mailer_type string Local only\" | debconf-set-selections\nRUN echo \"postfix postfix/mailname string localhost.localdomain\" | debconf-set-selections\n#  Redis Setup\nRUN sed -i 's/^\\(daemonize\\s*\\)yes\\s*$/\\1no/g' /etc/redis/redis.conf\n#  Install PEAR packages\nRUN pear install Crypt_GPG >> /tmp/install.log\nRUN pear install Net_GeoIP\n#  Apache Setup\nRUN cp /var/www/MISP/INSTALL/apache.misp.ubuntu /etc/apache2/sites-available/misp.conf\nRUN sed -i -E 's/80/800/' /etc/apache2/sites-available/misp.conf\nRUN sed -i -E 's/80/800/' /etc/apache2/ports.conf\nRUN a2dissite 000-default\nRUN a2ensite misp\nRUN a2enmod rewrite\nRUN a2enmod headers\n#  MISP base configuration\nRUN sudo -u www-data cp -a /var/www/MISP/app/Config/bootstrap.default.php /var/www/MISP/app/Config/bootstrap.php\nRUN sudo -u www-data cp -a /var/www/MISP/app/Config/database.default.php /var/www/MISP/app/Config/database.php\nRUN sudo -u www-data cp -a /var/www/MISP/app/Config/core.default.php /var/www/MISP/app/Config/core.php\nRUN sudo -u www-data cp -a /var/www/MISP/app/Config/config.default.php /var/www/MISP/app/Config/config.php\nRUN chown -R www-data:www-data /var/www/MISP/app/Config\nRUN chmod -R 750 /var/www/MISP/app/Config\n#  Replace the default salt\nRUN sed -i -E \"s/'salt'\\s=>\\s'(\\S+)'/'salt' => '`openssl rand -base64 32 | tr \"/\" \"-\" `'/\" /var/www/MISP/app/Config/config.php\n#  Enable workers at boot time\nRUN chmod a+x /var/www/MISP/app/Console/worker/start.sh\nRUN echo \"sudo -u www-data bash /var/www/MISP/app/Console/worker/start.sh\" >> /etc/rc.local\n#  Install MISP Modules\nWORKDIR /opt\nRUN apt-get update\nRUN apt-get install python3 python3-pip libjpeg-dev -y\nCOPY --from=builder_2.4.107 /opt/ .\nADD misp-modules /opt/misp-modules\nWORKDIR /opt/misp-modules\nRUN pip3 install --upgrade pip\nRUN cat REQUIREMENTS | sed 's/aiohttp==3.4.4/aiohttp/g' > REQUIREMENTS\nRUN pip3 install --upgrade --ignore-installed urllib3\nRUN pip3 install --upgrade --ignore-installed requests\nRUN sed -i 's/aiohttp.*/aiohttp/g' REQUIREMENTS\nRUN sed -i 's/functools.*//g' REQUIREMENTS\nRUN sed -i 's/async-timeout.*/async-timeout/g' REQUIREMENTS\nRUN sed -i 's/url-normalize.*/url-normalize/g' REQUIREMENTS\nRUN sed -i 's/^\\(yarl\\)\\=.*/\\1/g' REQUIREMENTS\nRUN sed -i 's/^\\(sigmatools\\)\\=.*/\\1/' REQUIREMENTS\nRUN pip3 install -I -r REQUIREMENTS\nRUN pip3 install -I .\nRUN pip install zmq redis\nRUN pip3 install zmq redis\nRUN echo \"sudo -u www-data misp-modules -s &\" >> /etc/rc.local\n#  Supervisord Setup\nRUN echo '[supervisord]' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'nodaemon = true' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '[program:postfix]' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'process_name = master' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'directory = /etc/postfix' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'command = /usr/sbin/postfix -c /etc/postfix start' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'startsecs = 0' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'autorestart = false' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '[program:redis-server]' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'command=redis-server /etc/redis/redis.conf' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '[program:apache2]' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'command=/bin/bash -c \"source /etc/apache2/envvars \\\n && exec /usr/sbin/apache2 -D FOREGROUND\"' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '[program:resque]' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'command=/bin/bash /var/www/MISP/app/Console/worker/start.sh' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'user = www-data' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'startsecs = 0' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'autorestart = false' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '[program:misp-modules]' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'command=/bin/bash -c \"cd /opt/misp-modules/bin \\\n && /usr/bin/python3 misp-modules.py\"' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'user = root' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'startsecs = 0' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'autorestart = false' >> /etc/supervisor/conf.d/supervisord.conf\n#  Modify syslog configuration\nRUN sed -i -E 's/^(\\s*)system\\(\\);/\\1unix-stream(\"\\/dev\\/log\");/' /etc/syslog-ng/syslog-ng.conf\n#  Add run script\nADD run.sh /run.sh\nADD csp_configuration /csp_configuration\nRUN chmod 0755 /run.sh\n#  Trigger to perform first boot operations\nRUN touch /.firstboot.tmp\nRUN touch /var/www/MISP/app/tmp/logs/error.log\nRUN touch /var/www/MISP/app/tmp/logs/debug.log\nRUN chmod -R 777 /var/www/MISP/app/tmp/logs/\nRUN chown -R www-data:www-data /var/www/MISP/app/tmp/logs/\nVOLUME [\"/var/www/MISP/app/tmp/logs\"]\n#  Make a backup of /var/www/MISP to restore it to the local moint point at first boot\nWORKDIR /var/www/MISP\n#  Add misp-objects for CSP support\nCOPY csp-misp-objects/ app/files/misp-objects/objects/\nRUN chown -R www-data:www-data /var/www/MISP/app/files/\n#  Final archive\nRUN tar czpf /root/MISP.tgz .\n# COPY AppController.php /var/www/MISP/app/Controller/AppController.php\n# VOLUME /var/www/MISP\nEXPOSE 80/tcp\nENTRYPOINT [\"/run.sh\"]\n","injectedSmells":[],"originalDockerfileHash":"405bbb6634141e50944576a0764cb69d","successfullyInjectedSmells":[],"originalDockerfileUglified":"FROM csp-alpine35glibc:1.0 AS builder_2.4.107\nRUN apk add --no-cache git\nWORKDIR /var/www\n#  RUN chown www-data:www-data /var/www\n#  USER www-data\nRUN git clone https://github.com/MISP/MISP.git\nWORKDIR /var/www/MISP\n#  RUN git checkout tags/$(git describe --tags `git rev-list --tags --max-count=1000`)\nRUN git checkout tags/$( git describe --tags v2.4.107 ;)\nRUN git config core.filemode false\nWORKDIR /var/www/MISP/app/files/scripts\nRUN git clone https://github.com/CybOXProject/python-cybox.git\nRUN git clone https://github.com/STIXProject/python-stix.git\nWORKDIR /var/www/MISP/app/files/scripts/python-cybox\nRUN git checkout v2.1.0.12\n#  USER www-data\nWORKDIR /var/www/MISP/app/files/scripts/python-stix\nRUN git checkout v1.1.1.4\n#  USER www-data\nWORKDIR /var/www/MISP\nRUN git submodule init\nRUN git submodule update\n#   Install MISP Modules\nWORKDIR /opt\nRUN git clone https://github.com/MISP/misp-modules.git\nFROM ubuntu:16.04\nMAINTAINER Christos Panagiotou\n#   Install core components\nENV DEBIAN_FRONTEND=\"noninteractive\"\nRUN apt-get update \\\n && apt-get dist-upgrade -y \\\n && apt-get autoremove -y \\\n && apt-get clean\nRUN apt-get install software-properties-common -y\nRUN apt-get install postfix -y\nRUN apt-get install mysql-client curl gcc gnupg-agent make python openssl redis-server sudo vim zip locales -y\nRUN locale-gen en_US.UTF-8\nENV LANG=\"en_US.UTF-8\"\nRUN add-apt-repository -y ppa:ondrej/php \\\n && apt-get update\n#   Apache\nRUN apt-get install apache2 apache2-doc apache2-utils -y\nRUN a2dismod status\nRUN a2dissite 000-default\n#   PHP 7.2\nRUN apt-get install libapache2-mod-php php7.2 php7.2-cli php-crypt-gpg php7.2-dev php7.2-json php7.2-mysql php7.2-opcache php7.2-readline php7.2-redis php7.2-xml git -y\n#   Fix php.ini with recommended settings\nRUN sed -i \"s/max_execution_time = 30/max_execution_time = 300/\" /etc/php/7.2/apache2/php.ini\nRUN sed -i \"s/memory_limit = 128M/memory_limit = 512M/\" /etc/php/7.2/apache2/php.ini\nRUN sed -i \"s/upload_max_filesize = 2M/upload_max_filesize = 50M/\" /etc/php/7.2/apache2/php.ini\nRUN sed -i \"s/post_max_size = 8M/post_max_size = 50M/\" /etc/php/7.2/apache2/php.ini\nRUN apt-get install python-dev python-pip libxml2-dev libxslt1-dev zlib1g-dev python-setuptools -y\nRUN apt-get install cron logrotate supervisor syslog-ng-core -y\nRUN apt-get clean\nWORKDIR /var/www\nUSER www-data\nCOPY --from=builder_2.4.107 /var/www/ .\nWORKDIR /var/www/MISP/app/files/scripts/python-cybox\nUSER root\nRUN python setup.py install\nUSER www-data\nWORKDIR /var/www/MISP/app/files/scripts/python-stix\nUSER root\nRUN python setup.py install\nRUN chown -R www-data:www-data /var/www\nUSER www-data\nWORKDIR /var/www/MISP/app\nRUN php composer.phar config vendor-dir Vendor\nRUN php composer.phar install\nUSER root\nRUN phpenmod redis\nUSER www-data\nRUN cp -fa /var/www/MISP/INSTALL/setup/config.php /var/www/MISP/app/Plugin/CakeResque/Config/config.php\n#   Fix permissions\nUSER root\nRUN chown -R www-data:www-data /var/www/MISP\nRUN chmod -R 750 /var/www/MISP\nRUN chmod -R g+ws /var/www/MISP/app/tmp\nRUN chmod -R g+ws /var/www/MISP/app/files\nRUN chmod -R g+ws /var/www/MISP/app/files/scripts/tmp\nRUN cp /var/www/MISP/INSTALL/misp.logrotate /etc/logrotate.d/misp\n#   Preconfigure setting for packages\nRUN echo \"postfix postfix/main_mailer_type string Local only\" | debconf-set-selections\nRUN echo \"postfix postfix/mailname string localhost.localdomain\" | debconf-set-selections\n#   Redis Setup\nRUN sed -i 's/^\\(daemonize\\s*\\)yes\\s*$/\\1no/g' /etc/redis/redis.conf\n#   Install PEAR packages\nRUN pear install Crypt_GPG >> /tmp/install.log\nRUN pear install Net_GeoIP\n#   Apache Setup\nRUN cp /var/www/MISP/INSTALL/apache.misp.ubuntu /etc/apache2/sites-available/misp.conf\nRUN sed -i -E 's/80/800/' /etc/apache2/sites-available/misp.conf\nRUN sed -i -E 's/80/800/' /etc/apache2/ports.conf\nRUN a2dissite 000-default\nRUN a2ensite misp\nRUN a2enmod rewrite\nRUN a2enmod headers\n#   MISP base configuration\nRUN sudo -u www-data cp -a /var/www/MISP/app/Config/bootstrap.default.php /var/www/MISP/app/Config/bootstrap.php\nRUN sudo -u www-data cp -a /var/www/MISP/app/Config/database.default.php /var/www/MISP/app/Config/database.php\nRUN sudo -u www-data cp -a /var/www/MISP/app/Config/core.default.php /var/www/MISP/app/Config/core.php\nRUN sudo -u www-data cp -a /var/www/MISP/app/Config/config.default.php /var/www/MISP/app/Config/config.php\nRUN chown -R www-data:www-data /var/www/MISP/app/Config\nRUN chmod -R 750 /var/www/MISP/app/Config\n#   Replace the default salt\nRUN sed -i -E \"s/'salt'\\s=>\\s'(\\S+)'/'salt' => '`openssl rand -base64 32 | tr \"/\" \"-\" `'/\" /var/www/MISP/app/Config/config.php\n#   Enable workers at boot time\nRUN chmod a+x /var/www/MISP/app/Console/worker/start.sh\nRUN echo \"sudo -u www-data bash /var/www/MISP/app/Console/worker/start.sh\" >> /etc/rc.local\n#   Install MISP Modules\nWORKDIR /opt\nRUN apt-get update\nRUN apt-get install python3 python3-pip libjpeg-dev -y\nCOPY --from=builder_2.4.107 /opt/ .\nADD misp-modules /opt/misp-modules\nWORKDIR /opt/misp-modules\nRUN pip3 install --upgrade pip\nRUN cat REQUIREMENTS | sed 's/aiohttp==3.4.4/aiohttp/g' > REQUIREMENTS\nRUN pip3 install --upgrade --ignore-installed urllib3\nRUN pip3 install --upgrade --ignore-installed requests\nRUN sed -i 's/aiohttp.*/aiohttp/g' REQUIREMENTS\nRUN sed -i 's/functools.*//g' REQUIREMENTS\nRUN sed -i 's/async-timeout.*/async-timeout/g' REQUIREMENTS\nRUN sed -i 's/url-normalize.*/url-normalize/g' REQUIREMENTS\nRUN sed -i 's/^\\(yarl\\)\\=.*/\\1/g' REQUIREMENTS\nRUN sed -i 's/^\\(sigmatools\\)\\=.*/\\1/' REQUIREMENTS\nRUN pip3 install -I -r REQUIREMENTS\nRUN pip3 install -I .\nRUN pip install zmq redis\nRUN pip3 install zmq redis\nRUN echo \"sudo -u www-data misp-modules -s &\" >> /etc/rc.local\n#   Supervisord Setup\nRUN echo '[supervisord]' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'nodaemon = true' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '[program:postfix]' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'process_name = master' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'directory = /etc/postfix' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'command = /usr/sbin/postfix -c /etc/postfix start' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'startsecs = 0' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'autorestart = false' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '[program:redis-server]' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'command=redis-server /etc/redis/redis.conf' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '[program:apache2]' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'command=/bin/bash -c \"source /etc/apache2/envvars \\\n && exec /usr/sbin/apache2 -D FOREGROUND\"' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '[program:resque]' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'command=/bin/bash /var/www/MISP/app/Console/worker/start.sh' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'user = www-data' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'startsecs = 0' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'autorestart = false' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '[program:misp-modules]' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'command=/bin/bash -c \"cd /opt/misp-modules/bin \\\n && /usr/bin/python3 misp-modules.py\"' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'user = root' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'startsecs = 0' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'autorestart = false' >> /etc/supervisor/conf.d/supervisord.conf\n#   Modify syslog configuration\nRUN sed -i -E 's/^(\\s*)system\\(\\);/\\1unix-stream(\"\\/dev\\/log\");/' /etc/syslog-ng/syslog-ng.conf\n#   Add run script\nADD run.sh /run.sh\nADD csp_configuration /csp_configuration\nRUN chmod 0755 /run.sh\n#   Trigger to perform first boot operations\nRUN touch /.firstboot.tmp\nRUN touch /var/www/MISP/app/tmp/logs/error.log\nRUN touch /var/www/MISP/app/tmp/logs/debug.log\nRUN chmod -R 777 /var/www/MISP/app/tmp/logs/\nRUN chown -R www-data:www-data /var/www/MISP/app/tmp/logs/\nVOLUME [\"/var/www/MISP/app/tmp/logs\"]\n#   Make a backup of /var/www/MISP to restore it to the local moint point at first boot\nWORKDIR /var/www/MISP\n#   Add misp-objects for CSP support\nCOPY csp-misp-objects/ app/files/misp-objects/objects/\nRUN chown -R www-data:www-data /var/www/MISP/app/files/\n#   Final archive\nRUN tar czpf /root/MISP.tgz .\n#  COPY AppController.php /var/www/MISP/app/Controller/AppController.php\n#  VOLUME /var/www/MISP\nEXPOSE 80/tcp\nENTRYPOINT [\"/run.sh\"]\n","originalDockerfileUglifiedHash":"3804b3e607f40577be64ad3316484004","fileName":"/ICSME-replicationpackage/dataset/smelly_dockerfiles_bianncle/cae435ade72b7b2f5400b2f154d29d528cacb559.dockerfile"}